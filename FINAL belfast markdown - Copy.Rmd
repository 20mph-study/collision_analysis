---
title: "belfast check 2"
date: "19/12/2019"
output: html_document
---


```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Load libraries
library(rgdal)
library(leaflet)
library(tidyverse)
library(rgeos)
library(raster)
library(ggplot2)
library(sf)
library(mapview)
library(maptools)
library(sp)
library(readxl)
library(readr)

#Function for deleting Na points
delete_na <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}

```

>Belfast road network changed to 20mph

```{r, echo=FALSE, warning=FALSE, message=FALSE}
#1.GIS 

# Define network dir path
dir_path <- 'V:Studies\\MOVED\\HealthImpact\\data\\20mph study collisions\\'
#Read geodatabase for Belfast

#Road data 
# Load data from the network drive for Belfast road network
belfast_road_data <- readOGR(paste0(dir_path, '20mph Speed Limit Streets\\20mph_Speed_Limit_Streets.shp'), verbose = FALSE)
# Tranform the data by applying a projection
belfast_road_data <- spTransform(belfast_road_data, "+init=epsg:4326")
belfast_road_data@data <-rowid_to_column(belfast_road_data@data, "ID")
# Visualize using leaflet
leaflet(belfast_road_data) %>% addTiles() %>% addPolygons() %>% setView(lng = -5.926437 , lat = 54.607868, zoom = 14)

```

>Belfast city center zones

```{r, echo=FALSE, warning=FALSE, message=FALSE}

#Output Areas 
gdb_path_out <- paste0(dir_path, "OA_ni-ESRI_format\\OA_ni.shp")
gdb_layers <- ogrListLayers(gdb_path_out)

belf_impl_zones_out <- readOGR(dsn = gdb_path_out, layer="OA_ni", verbose = FALSE)
belf_impl_zones_out <- spTransform(belf_impl_zones_out, "+init=epsg:4326")
belf_impl_zones_out <- belf_impl_zones_out[belf_impl_zones_out@data$OA_CODE %in% c("95GG390015","95GG200003","95GG350003","95GG350004",
                                                                                   "95GG390013","95GG350001","95GG210002","95GG400007",
                                                                                   "95GG390012","95GG390011","95GG350005"),]
leaflet(belf_impl_zones_out) %>% addTiles() %>% addPolygons()

```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
#READ DATA
#PSNI data
#Belfast data 
filename <- "V:\\Studies\\MOVED\\HealthImpact\\Data\\20mph study collisions\\Belfast\\Collisions 1998-2017.xls"
bel <- read_excel(filename)
belf_data <- read_excel(filename, sheet = 2)
colnames(belf_data) <- colnames(bel)
belf_data$a_date <- as.Date(belf_data$a_date,format="%m/%d/%Y")
belf_data <- belf_data %>% mutate(year = format(as.Date(belf_data$a_date, format="%m/%d/%Y"),"%Y"))
belf_data <- belf_data[belf_data$year >="2013" & belf_data$year <= "2015", ] %>% filter(!is.na(a_date))

#Belfast data 2018
file_path <- "V:\\Studies\\MOVED\\HealthImpact\\Data\\"
belf_2018 <-  read_csv(paste0(file_path, "20mph study collisions\\Belfast\\Collisions Jan2018 Mar2019.csv"))
belf_2018 <- belf_2018 %>% mutate(year = format(as.Date(belf_2018$a_date, format="%m/%d/%Y"),"%Y"))

belf_2018$a_date <- as.Date(belf_2018$a_date,format="%m/%d/%Y")


belf_2018 <- belf_2018 %>% filter(belf_2018$LGDNAME == "Belfast City") 
belf_2018 <- belf_2018 %>% filter(belf_2018$a_speed %in% c(20,30,40)) 

belf_2018 %>% group_by(year) %>% summarise(nr = n())

belf_data <- rbind(belf_data,belf_2018)

belf_data <- belf_data %>% filter(belf_data$LGDNAME == "Belfast City") 
belf_data <- belf_data %>% filter(belf_data$a_speed %in% c(20,30,40)) 
coord <- belf_data %>%
  st_as_sf(coords = c("a_gd1","a_gd2"), crs = 29903) %>%
  st_transform(4326) %>%
  st_coordinates() %>%
  as_tibble()

belf_data <- data.frame(belf_data,coord)

#Create new csv file with the cleaned data
write.csv(belf_data, file ="V:\\Studies\\MOVED\\HealthImpact\\Data\\20mph study collisions\\Belf_data.csv",row.names=FALSE)

```

>Time series Analysis

```{r,echo=FALSE, warning=FALSE,message=FALSE}
ggplot(belf_data) +
 aes(x = a_date, colour = a_speed) +
 geom_histogram(bins = 30L, fill = "#0c4c8a") +
 scale_color_distiller(palette = "Greens") +
 theme_minimal()

ggplot(belf_data) +
 aes(x = a_date, weight = a_speed) +
 geom_bar(fill = "#0c4c8a") +
 theme_minimal()
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
#Nearest line
df <- belf_data
road_net <- belfast_road_data

#Create planar(cartesian) projection 
crs <- CRS( "+proj=utm +zone=32 +ellps=WGS72 +units=m +no_defs")     # UTM zone = 32 N
wgs84 <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")  # long/lat
  
#Convert data to planar projection  
road_net <- spTransform(road_net,crs)
df <-  spTransform(SpatialPointsDataFrame(coords = df[26:27],proj4string = wgs84,data = df), crs)

#Make sure our data have same projections
proj4string(df) <- proj4string(road_net)
  
#Find nearest line with maxDist=20m 
nearest_line_sp <- snapPointsToLines(df,road_net,maxDist=10)


#belfast_road_data@data <-rowid_to_column(belfast_road_data@data, "ID")
nearest_line_sp <- spTransform(nearest_line_sp,"+init=epsg:4326")

#Merge the dataframes based on the ID of the nearest line in order to connect geoinformation
merged <- merge(data.frame(nearest_line_sp), road_net@data,by.x = "nearest_line_id" ,by.y = "ID")

```


```{r, echo=FALSE, warning=FALSE, message=FALSE}
count <- function(data_df){
  count2 <- aggregate(a_ID~a_speed,data_df,length)
  print(count2)
}
```

>Mapping accidents with roads: 2013
 
```{r, echo=FALSE, warning=FALSE, message=FALSE}
#Plot results
total <- merged[merged$year == "2013", ]
nrow(total)
leaflet(belfast_road_data) %>% addTiles() %>% addPolygons() %>%
                         setView(lng = -5.926437 , lat = 54.607868, zoom = 14) %>%
                         addCircleMarkers(data = total,lng = total$X.1,lat=total$Y.1) %>% 
                          addMarkers(lng = total$X, lat = total$Y, 
                                      popup = paste("Accident index: ", total$a_ID, "<br>",
                                                    "Speed limit: ", total$a_speed ))
#nrow(total[total$a_date >="2013-01-01" & total$a_date <= "2013-12-31", ])
count(total[total$year == "2013", ])
```

>Mapping accidents with roads: 2014

```{r, echo=FALSE, warning=FALSE, message=FALSE}
total <- merged[merged$year == "2014", ]
leaflet(belfast_road_data) %>% addTiles() %>% addPolygons() %>%
                         setView(lng = -5.926437 , lat = 54.607868, zoom = 14) %>%
                         addCircleMarkers(data = total,lng = total$X.1,lat=total$Y.1) %>% 
                          addMarkers(lng = total$X, lat = total$Y, 
                                      popup = paste("Accident index: ", total$a_ID, "<br>",
                                                    "Speed limit: ", total$a_speed ))
#nrow(total[total$a_date >="2014-01-01" & total$a_date <= "2014-12-31", ])
count(total[total$year == "2014", ])
```

>Mapping accidents with roads: 2015

```{r, echo=FALSE, warning=FALSE, message=FALSE}
total <- merged[merged$year == "2015", ]
leaflet(belfast_road_data) %>% addTiles() %>% addPolygons() %>%
                         setView(lng = -5.926437 , lat = 54.607868, zoom = 14) %>%
                         addCircleMarkers(data = total,lng = total$X.1,lat=total$Y.1) %>% 
                          addMarkers(lng = total$X, lat = total$Y, 
                                      popup = paste("Accident index: ", total$a_ID, "<br>",
                                                    "Speed limit: ", total$a_speed ))
#nrow(total[total$a_date >="2015-01-01" & total$a_date <= "2015-12-31", ])
count(total[total$year == "2015", ])
```

>Mapping accidents with roads: 2018

```{r, echo=FALSE, warning=FALSE, message=FALSE}
total <- merged[merged$year == "2018" , ]
leaflet(belfast_road_data) %>% addTiles() %>% addPolygons() %>%
                         setView(lng = -5.926437 , lat = 54.607868, zoom = 14) %>%
                         addCircleMarkers(data = total,lng = total$X.1,lat=total$Y.1) %>% 
                          addMarkers(lng = total$X, lat = total$Y, 
                                      popup = paste("Accident index: ", total$a_ID, "<br>",
                                                    "Speed limit: ", total$a_speed ))
#nrow(total[total$a_date >="2018-01-01" & total$a_date <= "2018-12-31", ])
count(total[total$year == "2018", ])
```

>Mapping accidents with roads: 2019

```{r, echo=FALSE, warning=FALSE, message=FALSE}
total <- merged[merged$year == "2019" , ]
leaflet(belfast_road_data) %>% addTiles() %>% addPolygons() %>%
                         setView(lng = -5.926437 , lat = 54.607868, zoom = 14) %>%
                         addCircleMarkers(data = total,lng = total$X.1,lat=total$Y.1) %>% 
                          addMarkers(lng = total$X, lat = total$Y, 
                                      popup = paste("Accident index: ", total$a_ID, "<br>",
                                                    "Speed limit: ", total$a_speed ))
#nrow(total[total$a_date >="2019-01-01" & total$a_date <= "2019-12-31", ])
count(total[total$year == "2019", ])
```

>Output column: Changed to 20 mph

```{r, echo=FALSE, warning=FALSE, message=FALSE}
head(merged[,c(25,13,36,41)])
```


```{r, echo=FALSE, warning=FALSE, message=FALSE}
#Link every accident with a zone

#Create planar(cartesian) projection 
crs <- CRS( "+proj=utm +zone=32 +ellps=WGS72 +units=m +no_defs")     # UTM zone = 32 N
wgs84 <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")  # long/lat

#Convert data to planar projection  
belf_impl_zones_out <- spTransform(belf_impl_zones_out,crs)
utm_data <-  spTransform(SpatialPointsDataFrame(coords = belf_data[26:27],proj4string = wgs84,data = belf_data), crs)

#Make sure our data have same projections
proj4string(utm_data) <- proj4string(belf_impl_zones_out)

#add a buffer around the point
points_polygons <- gBuffer(utm_data, width=5, byid = TRUE )
count_zones <- over(points_polygons,belf_impl_zones_out,returnList = FALSE)
count_zones <- rowid_to_column(count_zones,"ID")
belf_data <- rowid_to_column(belf_data,"index_ID")
total_zones <- merge(belf_data,count_zones,by.x="index_ID",by.y="ID")

#Convert data projections back to lat/long to plot with leaflet
belf_impl_zones_out <- spTransform(belf_impl_zones_out,"+init=epsg:4326")
#total_zones <- spTransform(total_zones, "+init=epsg:4326")
belf_impl_zones_out <- st_as_sf(belf_impl_zones_out)
#df_na <- na.omit(df_zones[1:4]) # check how many are missing

total_zones <- delete_na(total_zones,c("X_COORD" ,"Y_COORD"))
total_zones$a_type <- as.character(total_zones$a_type )
total_zones$a_type [total_zones$a_type  == 1] <- "fatal collision"
total_zones$a_type [total_zones$a_type  == 2] <- "Serious collision"
total_zones$a_type [total_zones$a_type  == 3] <- "Slight collision"



```

>Mapping accidents with zones: 2013

```{r, echo=FALSE, warning=FALSE, message=FALSE}
total <- total_zones[total_zones$year == "2013", ]
leaflet(belf_impl_zones_out) %>% addTiles() %>% addPolygons() %>%
                         setView(lng = -5.926437 , lat = 54.607868, zoom = 14) %>% 
                          addMarkers(lng = total$X, lat = total$Y, 
                                      popup = paste("Accident index: ", total$a_ID, "<br>",
                                                    "Speed limit: ", total$a_speed, "<br>",
                                                    "Accident severity: " , total$a_type, "<br>",
                                                    "Zone(OA code): " , total$OA_CODE ))

```

>Mapping accidents with zones: 2014

```{r, echo=FALSE, warning=FALSE, message=FALSE}
total <- total_zones[total_zones$year == "2014", ]
leaflet(belf_impl_zones_out) %>% addTiles() %>% addPolygons() %>%
                         setView(lng = -5.926437 , lat = 54.607868, zoom = 14) %>% 
                          addMarkers(lng = total$X, lat = total$Y, 
                                      popup = paste("Accident index: ", total$a_ID, "<br>",
                                                    "Speed limit: ", total$a_speed , "<br>",
                                                    "Accident severity: " , total$a_type, "<br>",
                                                    "Zone(OA code): " , total$OA_CODE ))
```

>Mapping accidents with zones: 2015

```{r, echo=FALSE, warning=FALSE, message=FALSE}
total <- total_zones[total_zones$year == "2015", ]
leaflet(belf_impl_zones_out) %>% addTiles() %>% addPolygons() %>%
                         setView(lng = -5.926437 , lat = 54.607868, zoom = 14) %>% 
                          addMarkers(lng = total$X, lat = total$Y, 
                                      popup = paste("Accident index: ", total$a_ID, "<br>",
                                                    "Speed limit: ", total$a_speed, "<br>",
                                                    "Accident severity: " , total$a_type, "<br>",
                                                    "Zone(OA code): " , total$OA_CODE  ))
```

>Mapping accidents with zones: 2018

```{r, echo=FALSE, warning=FALSE, message=FALSE}
total <- total_zones[total_zones$year == "2018", ]
leaflet(belf_impl_zones_out) %>% addTiles() %>% addPolygons() %>%
                         setView(lng = -5.926437 , lat = 54.607868, zoom = 14) %>% 
                          addMarkers(lng = total$X, lat = total$Y, 
                                      popup = paste("Accident index: ", total$a_ID, "<br>",
                                                    "Speed limit: ", total$a_speed , "<br>",
                                                    "Accident severity: " , total$a_type, "<br>",
                                                    "Zone(OA code): " , total$OA_CODE ))

```

>Mapping accidents with zones: 2019

```{r, echo=FALSE, warning=FALSE, message=FALSE}
total <- total_zones[total_zones$year == "2019", ]
leaflet(belf_impl_zones_out) %>% addTiles() %>% addPolygons() %>%
                         setView(lng = -5.926437 , lat = 54.607868, zoom = 14) %>% 
                          addMarkers(lng = total$X, lat = total$Y, 
                                      popup = paste("Accident index: ", total$a_ID, "<br>",
                                                    "Speed limit: ", total$a_speed, "<br>",
                                                    "Accident severity: " , total$a_type , "<br>",
                                                    "Zone(OA code): " , total$OA_CODE ))
```

>Output column : Output Area code ( OA_code)

```{r, echo=FALSE, warning=FALSE, message=FALSE}
head(total_zones[,c(25,13,34)])
```

