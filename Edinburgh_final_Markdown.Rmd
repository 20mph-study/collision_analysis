---
title: "Edinburgh Markdown"
output: html_document
---


```{r,echo=FALSE,warning=FALSE,message=FALSE,comment = FALSE}
# Load libraries
library(rgdal)
library(leaflet)
library(tidyverse)
library(rgeos)
library(raster)
library(ggplot2)
library(sf)
library(mapview)
library(maptools)
library(sp)
library(readxl)
library(readr)
library(grid)
library(gridExtra)
library(xtable)

#1.Function for keeping data of Edinburgh with speed limits 20/30/40
filter_data <- function(data){
  data <- data %>% filter(data$Speed_limit %in% c(20,30,40)) 
  data <- data %>% filter(data$`Local_Authority_(District)` == 923)
  #data$Date <- as.Date(data$Date,format="%d/%m/%Y")
  data <- na.omit(data[1:31])#remove NA obs
  return(data)
}

#2.Function for deleting Na points
delete_na <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}

#Data inputs
##1.Data path 
#dir_path <- "C:\\Users\\Kyriaki Kokka\\Desktop\\"
dir_path <- "V:\\Studies\\MOVED\\HealthImpact\\Data\\"

#2.Gis 
#Read geodatabase for Edinburgh
#Path
gdb_path <- paste0(dir_path, "20mph study collisions\\20mph.gdb")
gdb_layers <- ogrListLayers(gdb_path)

```

>Edinburgh's road network

```{r,echo=FALSE,warning=FALSE,message=FALSE} 
#Read shapefile
edin_cons_streets <- readOGR(dsn = gdb_path,layer="Consultation20mphStreets")
#Put ID column as variable 
edin_cons_streets@data <-rowid_to_column(edin_cons_streets@data, "ID")
#Transform to long/lat
edin_cons_streets <- spTransform(edin_cons_streets, "+init=epsg:4326")
#Visualize with leaflet
spplot(edin_cons_streets,'LAYER')
leaflet(edin_cons_streets) %>% addTiles() %>% addPolygons()
```

>Edinburgh's control zones

```{r,echo=FALSE,warning=FALSE,message=FALSE} 
#Read shapefile
edin_impl_zones <- readOGR(dsn = gdb_path, layer="ImplementationZones")
#Transform to long/lat
edin_impl_zones <- spTransform(edin_impl_zones, "+init=epsg:4326")
#Change zone 1
edin_impl_zones@data$ImplementationZone <- as.integer(edin_impl_zones@data$ImplementationZone)
edin_impl_zones@data[6,]$ImplementationZone <- 7
#Visualize with leaflet
spplot(edin_impl_zones,"ImplementationZone")
leaflet(edin_impl_zones) %>% addTiles() %>% addPolygons()
```


```{r, echo=FALSE, warning=FALSE,message=FALSE}
#3.Read csv files
#Read every year seperately
#Read csv file from 2005 to 2014
rd_source <- read_csv(paste0(dir_path, "20mph study collisions\\collisions\\collisions 2005 to 2014.csv"))  
rd_source$Date <- as.Date(rd_source$Date,format="%d/%m/%Y")

#2013 data
rd_2013 <- rd_source[rd_source$Date >="2013-01-01" & rd_source$Date <= "2013-12-31", ] %>% filter(!is.na(Date))
rd_2013$Date <- as.Date(rd_2013$Date,format="%d/%m/%Y")

#2014 data
rd_2014 <- rd_source[rd_source$Date >="2014-01-01" & rd_source$Date <= "2014-12-31", ] %>% filter(!is.na(Date))
rd_2014b <- read_csv(paste0(dir_path, "20mph study collisions\\collisions\\collisions 2014.csv"))
rd_2014b$Date <- as.Date(rd_2014b$Date,format="%d/%m/%Y")
rd_2014 <- rbind(rd_2014,rd_2014b)
rd_2014$Date <- as.Date(rd_2014$Date,format="%d/%m/%Y")


#2015 data
rd_2015 <- read_csv(paste0(dir_path, "20mph study collisions\\collisions\\collisions 2015.csv"))
rd_2015$Date <- as.Date(rd_2015$Date,format="%d/%m/%Y")

#2018 data
rd_2018 <- read_csv(paste0(dir_path, "20mph study collisions\\collisions\\collisions 2018.csv"))
rd_2018$Date <- as.Date(rd_2018$Date,format="%d/%m/%Y")

#2019 data
#rd_2019 <- read_excel("C:\\Users\\Kyriaki Kokka\\Desktop\\20mph study collisions\\collisions\\collisions 2019 Jan to May Edinburgh only.xls")
#rd_2019 <- rd_2019%>%filter(rd_2019$`Speed Limit`  %in% c(20,30,40)) 

edin_road_data <-rbind(rd_2013,rd_2014,rd_2015,rd_2018) 
edin_road_data <- filter_data(edin_road_data)
edin_road_data <-delete_na(edin_road_data,c("Longitude","Latitude"))
edin_road_data$Accident_Severity <- as.character(edin_road_data$Accident_Severity)
edin_road_data$Accident_Severity[edin_road_data$Accident_Severity == 1] <- "fatal collision"
edin_road_data$Accident_Severity[edin_road_data$Accident_Severity == 2] <- "Serious collision"
edin_road_data$Accident_Severity[edin_road_data$Accident_Severity == 3] <- "Slight collision"

data <- edin_road_data
edin_road_data <-rowid_to_column(edin_road_data, "ID")
df <- data
data <- rowid_to_column(data,"index_ID")
```

>Time series analysis

```{r, echo=FALSE, warning=FALSE,message=FALSE}
ggplot(edin_road_data) +
 aes(x = Date, colour = Speed_limit) +
 geom_histogram(bins = 30L, fill = "#0c4c8a") +
 scale_color_distiller(palette = "Greens") +
 theme_minimal()

ggplot(edin_road_data) +
 aes(x = Date, weight = Speed_limit) +
 geom_bar(fill = "#0c4c8a") +
 theme_minimal()

```


```{r, echo=FALSE, warning=FALSE,message=FALSE}

#Functions for the analysis
#Function for the nearest line
nearest_line <-function(df,road_net){
  #Create planar(cartesian) projection 
  crs <- CRS( "+proj=utm +zone=32 +ellps=WGS72 +units=m +no_defs")     # UTM zone = 32 N
  wgs84 <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")  # long/lat
  
  #Convert data to planar projection  
  road_net <- spTransform(road_net,crs)
  df <-  spTransform(SpatialPointsDataFrame(coords = df[5:6],proj4string = wgs84,data = df), crs)
  
  #Make sure our data have same projections
  proj4string(df) <- proj4string(road_net)
  
  #Find nearest line with maxDist=20m 
  nearest_line_sp <- snapPointsToLines(df,road_net,maxDist=10)
  
  return(nearest_line_sp)
}

#Function for leaflet visualisations
leaflet_map <- function(final_df,road_df,edin_streets){
  crs <- CRS( "+proj=utm +zone=32 +ellps=WGS72 +units=m +no_defs")     # UTM zone = 32 N
  wgs84 <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")  # long/lat
  
  #Convert data to planar projection  
  edin_streets <- spTransform(edin_streets,crs)
  coordinates(road_df) <- ~ Longitude + Latitude
  coordinates(final_df) <- ~ X + Y
  
  #Convert data projections back to lat/long to plot with leaflet
  edin_streets <- spTransform(edin_streets,"+init=epsg:4326")
  
  #Same projections
  proj4string(final_df) <- proj4string(edin_streets)
  proj4string(road_df) <- proj4string(edin_streets)
  
  edin_streets <- st_as_sf(edin_streets)
  #Leaflet maps of the road network , accidents and their projections
  road_existing_20 <-edin_streets%>% filter(edin_streets$LAYER == "20mph existing streets")
  road_local_20 <- filter(edin_streets, edin_streets$LAYER == "20mph local streets")
  road_main_20 <- filter(edin_streets, edin_streets$LAYER == "20mph main streets")
  road_30 <- filter(edin_streets, edin_streets$LAYER == "30mph")
  road_40 <- filter(edin_streets, edin_streets$LAYER == "40mph")
  road_part <- filter(edin_streets, edin_streets$LAYER == "Part time 20mph")
  road_50 <- filter(edin_streets, edin_streets$LAYER == "50, 60 or 70mph")
  road_trunk <- filter(edin_streets, edin_streets$LAYER == "Trunk roads")
  
  
  #Visualize
  map <- leaflet() %>% addTiles() %>% addPolygons(data = edin_streets)
  #map <- map %>%  addLegend("bottomright",colors =c("green",  "red", "yellow", "cyan", "blue","black","purple","orange"),
  #labels= c("existing 20mph", "local 20mph","main 20 mph","30mph","40mph", "part time 20mph","50,60 or 70mph","Trunk roads"),
  #title= "Road network",opacity = 1)
  map_near <-map %>% leaflet() %>% addTiles() %>% addMarkers(lng =final_df$X, lat = final_df$Y,
                                                             popup =paste("Accident index: ", final_df$Accident_Index, "<br>",
                                                                          "Speed limit: ", final_df$Speed_limit ,"<br>",
                                                                          "Layer: ",final_df$LAYER,"<br>",
                                                                          "Accident severity: ",final_df$Accident_Severity))
  road_df <- (data.frame(road_df))
  map3 <- map_near %>% addCircleMarkers(lng =road_df$Longitude , lat = road_df$Latitude,
                                        popup =paste("Accident index: ", road_df$Accident_Index, "<br>",
                                                     "Speed limit: ", road_df$Speed_limit ,"<br>",
                                                     "Accident severity: ",road_df$Accident_Severity ))
  

  map3 <- map3 %>% addLegend("bottomright",colors =c("green",  "red", "yellow", "cyan", "blue","black","purple","orange"),
                      labels= c("existing 20mph", "local 20mph","main 20 mph","30mph","40mph", "part time 20mph","50,60 or 70mph","Trunk roads"),
                      title= "Road network",opacity = 1)
  
  map3 %>%
  setView(lng = -3.188267 , lat = 55.953251, zoom = 11)%>%
    addPolylines(data = road_existing_20, color= "green")%>%
    addPolylines(data = road_local_20,color= "red")%>%
    addPolylines(data = road_main_20,color= "yellow")%>%
    addPolylines(data = road_30,color= "cyan")%>%
    addPolylines(data = road_40,color= "blue")%>%
    addPolylines(data = road_part,color= "black")%>%
    addPolylines(data = road_50,color= "purple")%>%
    addPolylines(data = road_trunk,color= "orange")
  
  
}

#Count function
count <- function(data_df){
  count1 <- aggregate(Accident_Index~LAYER,data_df,length)
  count2 <- aggregate(Accident_Index~Speed_limit,data_df,length)
  print(count1)
  print(count2)
}
```

```{r, echo=FALSE, warning=FALSE,message=FALSE}
#Data manipulation
#Get nearest line for pre and post 20mph using the nearest_line function 
nearest_road <- nearest_line(edin_road_data,edin_cons_streets)
nearest_road <- spTransform(nearest_road,"+init=epsg:4326")
```

```{r, echo=FALSE, warning=FALSE,message=FALSE}
#Merge the dataframes based on the ID of the nearest line in order to connect geoinformation with stasts19 
mergedDf <- merge(data.frame(nearest_road),edin_cons_streets@data,by.x = "nearest_line_id" ,by.y = "ID")
```

>Mapping accidents with roads: 2013

```{r, echo=FALSE, warning=FALSE,message=FALSE}
leaflet_map(mergedDf[mergedDf$Date >="2013-01-01" & mergedDf$Date <= "2013-12-31", ],edin_road_data[edin_road_data$Date >="2013-01-01" & edin_road_data$Date <= "2013-12-31", ],edin_cons_streets)
count(mergedDf[mergedDf$Date >="2013-01-01" & mergedDf$Date <= "2013-12-31", ])
```

>Mapping accidents with roads: 2014

```{r, echo=FALSE, warning=FALSE,message=FALSE}
leaflet_map(mergedDf[mergedDf$Date >="2014-01-01" & mergedDf$Date <= "2014-12-31", ],edin_road_data[edin_road_data$Date >="2014-01-01" & edin_road_data$Date <= "2014-12-31", ],edin_cons_streets)
count(mergedDf[mergedDf$Date >="2014-01-01" & mergedDf$Date <= "2014-12-31", ])
```

>Mapping accidents with roads: 2015

```{r, echo=FALSE, warning=FALSE,message=FALSE}
leaflet_map(mergedDf[mergedDf$Date >="2015-01-01" & mergedDf$Date <= "2015-12-31", ],edin_road_data[edin_road_data$Date >="2015-01-01" & edin_road_data$Date <= "2015-12-31", ],edin_cons_streets)
count(mergedDf[mergedDf$Date >="2015-01-01" & mergedDf$Date <= "2015-12-31", ])
```

>Mapping accidents with roads: 2018

```{r, echo=FALSE, warning=FALSE,message=FALSE}
leaflet_map(mergedDf[mergedDf$Date >="2018-01-01" & mergedDf$Date <= "2018-12-31", ],edin_road_data[edin_road_data$Date >="2018-01-01" & edin_road_data$Date <= "2018-12-31", ],edin_cons_streets)
count(mergedDf[mergedDf$Date >="2018-01-01" & mergedDf$Date <= "2018-12-31", ])
```

>Count pre 20mph

```{r,echo=FALSE,warning=FALSE,message=FALSE}
count(mergedDf[mergedDf$Date >="2013-01-01" & mergedDf$Date <= "2015-12-31", ])
```

>Count post 20mph

```{r,echo=FALSE,warning=FALSE,message=FALSE}
count(mergedDf[mergedDf$Date >="2018-01-01" & mergedDf$Date <= "2018-12-31", ])
```

>Output column: Layer

```{r,echo=FALSE,warning=FALSE,message=FALSE}
head(mergedDf[,c(3,20,39)])
```

```{r,echo=FALSE,warning=FALSE,message=FALSE}
#Create planar(cartesian) projection 
crs <- CRS( "+proj=utm +zone=32 +ellps=WGS72 +units=m +no_defs")     # UTM zone = 32 N
wgs84 <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")  # long/lat

#Convert data to planar projection  
edin_impl_zones <- spTransform(edin_impl_zones,crs)
utm_data <-  spTransform(SpatialPointsDataFrame(coords = data[5:6],proj4string = wgs84,data = data), crs)

proj4string(utm_data) <- proj4string(edin_impl_zones)

#add a buffer around the point
points_polygons <- gBuffer(utm_data, width=6, byid = TRUE )
count_zones <- over(points_polygons,edin_impl_zones,returnList = FALSE)
count_zones <- rowid_to_column(count_zones,"ID")

total_zones <- merge(data,count_zones,by.x="index_ID",by.y="ID")
df_zones <-data.frame(total_zones[2],total_zones[19],total_zones[35])

#Convert data projections back to lat/long to plot with leaflet
edin_impl_zones <- spTransform(edin_impl_zones,"+init=epsg:4326")
#total_zones <- spTransform(total_zones, "+init=epsg:4326")
utm_data <- spTransform(utm_data, "+init=epsg:4326")
#delete_na()
#df_na <- na.omit(df_zones[1:4]) # check how many are missing
```

>Mapping accidents with zones: 2013

```{r,echo=FALSE,warning=FALSE,message=FALSE}

edin_impl_zones <- st_as_sf(edin_impl_zones)
#Leaflet maps of the zones & accidents
zone_1 <- filter(edin_impl_zones,edin_impl_zones$ImplementationZone == 1)
zone_2 <- filter(edin_impl_zones,edin_impl_zones$ImplementationZone == 2)
zone_3 <- filter(edin_impl_zones,edin_impl_zones$ImplementationZone == 3)
zone_4 <- filter(edin_impl_zones,edin_impl_zones$ImplementationZone == 4)
zone_5 <- filter(edin_impl_zones,edin_impl_zones$ImplementationZone == 5)
zone_6 <- filter(edin_impl_zones,edin_impl_zones$ImplementationZone == 6)
zone_7 <- filter(edin_impl_zones,edin_impl_zones$ImplementationZone == 7)

#Visualize
map_zones <- leaflet() %>% addTiles() %>% 
  addPolygons(data = zone_1, color= "green")%>%
  addPolygons(data = zone_2,color= "red")%>%
  addPolygons(data = zone_3,color= "purple")%>%
  addPolygons(data = zone_4,color= "cyan")%>%
  addPolygons(data = zone_5,color= "blue")%>%
  addPolygons(data = zone_6,color= "orange")%>%
  addPolygons(data = zone_7,color= "black")

map_zones <- map_zones %>% addLegend("bottomright",colors =c("green",  "red","purple", "cyan", "blue","orange","black"),
                      labels= c("1:City Centre", "2:North","3:South Central/East","4:North West","5:West", "6:South","7:Rural West"),
                      title= "Control zones",opacity = 1) %>% setView(lng = -3.188267 , lat = 55.953251, zoom = 11)

total <- total_zones[total_zones$Date >="2013-01-01" & total_zones$Date <= "2013-12-31", ]

map_zones %>% addMarkers(lng =total$Longitude, lat = total$Latitude, 
                         popup =paste("Accident index: ", total$Accident_Index, "<br>",
                                      "Zone: ", total$ImplementationZone))

```

>Mapping accidents with zones: 2014

```{r,echo=FALSE,warning=FALSE,message=FALSE}
total <- total_zones[total_zones$Date >="2014-01-01" & total_zones$Date <= "2014-12-31", ]

map_zones %>%
  setView(lng = -3.188267 , lat = 55.953251, zoom = 11)%>%
  addMarkers(lng =total$Longitude, lat = total$Latitude, 
             popup =paste("Accident index: ", total$Accident_Index, "<br>",
                          "Zone: ", total$ImplementationZone))
``` 

>Mapping accidents with zones: 2015

```{r,echo=FALSE,warning=FALSE,message=FALSE}
total <- total_zones[total_zones$Date >="2015-01-01" & total_zones$Date <= "2015-12-31", ]

map_zones %>% addMarkers(lng =total$Longitude, lat = total$Latitude, 
                         popup =paste("Accident index: ", total$Accident_Index, "<br>",
                                      "Zone: ", total$ImplementationZone))
```

>Mapping accidents with zones: 2018

```{r,echo=FALSE,warning=FALSE,message=FALSE}
total <- total_zones[total_zones$Date >="2018-01-01" & total_zones$Date <= "2018-12-31", ]

map_zones %>% addMarkers(lng =total$Longitude, lat = total$Latitude, 
                         popup =paste("Accident index: ", total$Accident_Index, "<br>",
                                      "Zone: ", total$ImplementationZone))
```

>Output column: Implementation Zone

```{r,echo=FALSE,warning=FALSE,message=FALSE}
head(df_zones)
```
