---
title: "Belfast markdown"
output: html_document
---

```{r,echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE}
# Load libraries
library(rgdal)
library(leaflet)
library(tidyverse)
library(rgeos)
library(raster)
library(ggplot2)
library(sf)
library(mapview)
library(maptools)
library(sp)
library(readxl)
library(readr)
library(knitr)
library(kableExtra)
library(plyr)

source('../functions/localSnapPointsToLines.R')
source('../functions/nearest_line_belf.R')
source('../functions/read_belf_controldata.R')
source('../functions/time_plot_belf.R')
source('../functions/belcount.R')
source('../functions/read_bel_data.R')
source('../functions/belcount_pre.R')
source('../functions/read_belfcontrol_zone.R')
source('../functions/delete_na.R')
source('../functions/belcount_pre.R')
source('../functions/read_belf_road.R')
source('../functions/leaflet_map_belf.R')
source('../functions/read_belf_impl_zones.R')
source('../functions/belf_annual_table.R')
source('../functions/buffer_data.R')
source('../functions/belf_leaflet_zones.R')



# Define network dir path
dir_path <- "../data"
```

> Belfast road network changed to 20mph

```{r ,echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE}
#Road data 
belfast_road_data <- read_belf_road(dir_path)
leaflet(belfast_road_data) %>% addTiles() %>% addPolygons() %>% setView(lng = -5.926437 , lat = 54.607868, zoom = 14)
```

> Belfast city center implementation zone

```{r, echo=FALSE, warning=FALSE, message=FALSE}
#Output Areas 
belf_impl_zones_out <- read_belf_impl_zones(dir_path)
leaflet(belf_impl_zones_out) %>% addTiles() %>% addPolygons()
```

> Belfast's control zone

```{r, echo=FALSE, warning=FALSE, message=FALSE}
#control zones
belf_control_zones <- read_belfcontrol_zone(dir_path)
leaflet(belf_control_zones) %>% addTiles() %>% addPolygons() 
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
#PSNI data
belf_data <- read_bel_data(dir_path)
belf_control_data <- read_belf_controldata(dir_path)
```

> Time series Analysis

```{r,echo=FALSE, warning=FALSE,message=FALSE}
time_plot_belf(belf_data)
```

```{r,echo=FALSE, warning=FALSE,message=FALSE}
#Nearest line
merged <- nearest_line_belf(belf_data,belfast_road_data)
total <- merged
```

> Mapping accidents with roads: 2013

```{r, echo=FALSE, warning=FALSE, message=FALSE}
leaflet_map_belf(belfast_road_data, merged[merged$year == "2013", ])
belcount(merged[merged$year == "2013", ])
```

> Mapping accidents with roads: 2014

```{r, echo=FALSE, warning=FALSE, message=FALSE}
leaflet_map_belf(belfast_road_data,merged[merged$year == "2014", ])
belcount(merged[merged$year == "2014", ])
```

> Mapping accidents with roads: 2015

```{r, echo=FALSE, warning=FALSE, message=FALSE}
leaflet_map_belf(belfast_road_data,merged[merged$year == "2015", ])
belcount(merged[merged$year == "2015", ])
```

> Mapping accidents with roads: 2016

```{r,echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE}
leaflet_map_belf(belfast_road_data,merged[merged$year == "2016", ])
belcount(merged[merged$year == "2016", ])
```

> Mapping accidents with roads: 2018

```{r, echo=FALSE, warning=FALSE, message=FALSE}
leaflet_map_belf(belfast_road_data,merged[merged$year == "2018", ])
belcount(merged[merged$year == "2018", ])
```

> Mapping accidents with roads: 2019

```{r, echo=FALSE, warning=FALSE, message=FALSE}
leaflet_map_belf(belfast_road_data,merged[merged$year == "2019", ])
belcount(merged[merged$year == "2019", ])
```

> Count pre 20mph

```{r, echo=FALSE, warning=FALSE, message=FALSE}
pre <- belcount_pre(merged[merged$year >="2013" & merged$year <= "2016", ])
pre
```

> Count post 20mph

```{r, echo=FALSE, warning=FALSE, message=FALSE}
post <- belcount(merged[merged$year >="2018" & merged$year <= "2019", ])
post
```

> Table: Average annual road traffic collision rates in the city of Belfast ( GIS )

```{r, echo=FALSE, warning=FALSE, message=FALSE}
belf_annual_table(belf_data,pre,post)
```

> Effect estimate ( GIS )

```{r,echo=FALSE,warning=FALSE,message=FALSE}
a <- c(nrow(merged[merged$a_date >="2013-07-31" & merged$a_date <= "2014-12-30", ]))
b <- c(nrow(merged[merged$a_date >="2014-07-31" & merged$a_date <= "2015-12-30", ]))
c <- c(nrow(merged[merged$a_date >="2015-07-31" & merged$a_date <= "2016-07-20", ]))
d <- c(nrow(merged[merged$a_date >="2018-03-06" & merged$a_date <= "2019-12-31", ]))

sum1 <- (a+b+c)/3
sum2 <- d
unadjusted_estimate <-  (sum1 - sum2 ) / sum1  
secular_trend <- ( (a-b) / a  + (b-c) / b ) / 2
f <- ( unadjusted_estimate - secular_trend ) * 100

Y_2013_14 <- c(a," ", round(f,digits = 2))
Y_2014_15 <- c(b," "," ")
Y_2015_16 <- c(c," "," ")
Y_2018_19 <- c(d," "," ")

Tax_year <- c("Annual number of collisions in roads changed to 20mph"," ","Effect estimate ")
df <- data.frame(Tax_year,Y_2013_14,Y_2014_15,Y_2015_16,Y_2018_19)
colnames(df)=c("Tax year", "2013/14","2014/15","2015/16", "2018/19")
kable(df,caption = "Effect estimate(GIS)") %>% kable_styling(bootstrap_options = c("striped", "hover"))
```

> Output column: Changed to 20 mph

```{r, echo=FALSE, warning=FALSE, message=FALSE}
head(merged[,c(25,13,36,37,41)])
```


```{r, echo=FALSE, warning=FALSE, message=FALSE}
#Link every accident with a zone
belf_data <- rename(belf_data,c("X" = "Longitude","Y" = "Latitude"))
total_zones <- buffer_data(belf_data ,belf_impl_zones_out)
total_zones <- cbind(Zone_info = "Implementation zone", total_zones)

total_zones <- delete_na(total_zones,c("X_COORD" ,"Y_COORD"))
total_zones$a_type <- as.character(total_zones$a_type )
total_zones$a_type [total_zones$a_type  == 1] <- "fatal collision"
total_zones$a_type [total_zones$a_type  == 2] <- "Serious collision"
total_zones$a_type [total_zones$a_type  == 3] <- "Slight collision"
```

> Mapping accidents with zones: 2013

```{r, echo=FALSE, warning=FALSE, message=FALSE}
total <- total_zones[total_zones$a_date >="2013-01-01" & total_zones$a_date <= "2013-12-31", ]
belf_leaflet_zones(belf_impl_zones_out,total)
s_13 <- nrow(buffer_data(total,belf_impl_zones_out))
```

> Mapping accidents with zones: 2014

```{r, echo=FALSE, warning=FALSE, message=FALSE}
total <- total_zones[total_zones$a_date >="2014-01-01" & total_zones$a_date <= "2014-12-31", ]
belf_leaflet_zones(belf_impl_zones_out,total)
s_14 <- nrow(total)
```

> Mapping accidents with zones: 2015

```{r, echo=FALSE, warning=FALSE, message=FALSE}
total <- total_zones[total_zones$a_date >="2015-01-01" & total_zones$a_date <= "2015-12-31", ]
belf_leaflet_zones(belf_impl_zones_out,total)
s_15 <- nrow(buffer_data(total,belf_impl_zones_out))
```

> Mapping accidents with zones: 2016

```{r, echo=FALSE, warning=FALSE, message=FALSE}
total <- total_zones[total_zones$a_date >="2016-01-01" & total_zones$a_date <= "2016-12-20", ]
belf_leaflet_zones(belf_impl_zones_out,total)
s_16 <- nrow(buffer_data(total,belf_impl_zones_out))
```

> Mapping accidents with zones: 2018

```{r, echo=FALSE, warning=FALSE, message=FALSE}
total <- total_zones[total_zones$a_date >="2018-03-06" & total_zones$a_date <= "2018-12-31", ]
belf_leaflet_zones(belf_impl_zones_out,total)
s_18 <- nrow(buffer_data(total,belf_impl_zones_out))
```

> Mapping accidents with zones: 2019

```{r, echo=FALSE, warning=FALSE, message=FALSE}
total <- total_zones[total_zones$year == "2019", ]
belf_leaflet_zones(belf_impl_zones_out,total)
s_19 <- nrow(buffer_data(total,belf_impl_zones_out))
```

> Total accidents in the implementation zone

```{r, echo=FALSE, warning=FALSE, message=FALSE}
s_13 + s_14 + s_15 + s_16 + s_18 + s_19 
```

> Count accidents in Control Zone : City Center --> Central ( Ards )

```{r, echo=FALSE, warning=FALSE, message=FALSE}
belf_control_data <- rename(belf_control_data,c("X" = "Longitude","Y" = "Latitude"))
control_data_df <- buffer_data(belf_control_data,belf_control_zones)
control_data_df <- cbind(Zone_info = "Control zone", control_data_df)
leaflet(belf_control_zones) %>% addTiles() %>% addPolygons() %>% addMarkers(lng = control_data_df$Longitude,  lat = control_data_df$Latitude) %>% setView(lng = -5.69092, lat = 54.59236, zoom = 13)
nrow(control_data_df)
```

> Output column : Output Area code ( OA_code )

```{r, echo=FALSE, warning=FALSE, message=FALSE}
head(total_zones[,c(25,13,34)])
```

> Updated dataset for Belfast city

```{r, echo=FALSE, warning=FALSE, message=FALSE}
merged_1 <- merged[,-c(1,29:35,38:40,42:47)]
merged_1$a_time <- as.character(merged_1$a_time)
merged_1 <- rename(merged_1,c("X" = "Longitude","Y" = "Latitude"))

total_zones_1 <- total_zones[,-c(28:32)]
total_zones_1$a_time <- as.character(total_zones_1$a_time)
updated_dataset <- rbind.fill(merged_1,total_zones_1)

control_data_df$a_time <- as.character(control_data_df$a_time)

#final_dataset
final_df <- rbind.fill(updated_dataset,control_data_df)
final_df <- final_df[,-c(32,34:37)]
#Create new csv file with the cleaned data
write.csv(final_df, file = paste0(dir_path, "/Belfast/final_Belfast_data.csv"),row.names = FALSE)
```
