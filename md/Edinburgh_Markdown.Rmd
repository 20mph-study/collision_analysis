---
title: "Edinburgh Markdown"
output: html_document
---

```{r,echo=FALSE,warning=FALSE,message=FALSE}
# Load libraries
library(rgdal)
library(leaflet)
library(tidyverse)
library(rgeos)
library(raster)
library(ggplot2)
library(sf)
library(mapview)
library(maptools)
library(sp)
library(readxl)
library(readr)
library(grid)
library(gridExtra)
library(xtable)
library(knitr)
library(kableExtra)
library(plyr)
library(RColorBrewer)

source('../functions/localSnapPointsToLines.R')
source('../functions/nearest_line.R')
source('../functions/leaflet_map.R')
source('../functions/time_plot.R')
source('../functions/table_annual.R')
source('../functions/table_police.R')
source('../functions/buffer_data.R')
source('../functions/read_road_data.R')
source('../functions/filter_data.R')
source('../functions/delete_na.R')
source('../functions/count.R')
source('../functions/count_pre.R')
source('../functions/count_post.R')
source('../functions/count_impl.R')
source('../functions/add_zone_data.R')
source('../functions/read_controlzone_data.R')
source('../functions/table_zones.R')
source('../functions/map_zones.R')


##1.Data path 
dir_path <- "../data"
```

> Edinburgh's road network

```{r,echo=FALSE,warning=FALSE,message=FALSE} 
#Read geodatabase for Edinburgh
#Path
gdb_path <- paste0(dir_path, "/20mph.gdb")
gdb_layers <- ogrListLayers(gdb_path)

#Read shapefile
edin_cons_streets <- readOGR(dsn = gdb_path,layer="Consultation20mphStreets", verbose = FALSE)
#Put ID column as variable 
edin_cons_streets@data <-rowid_to_column(edin_cons_streets@data, "ID")
#Transform to long/lat
edin_cons_streets <- spTransform(edin_cons_streets, "+init=epsg:4326")

edin_road_network <- edin_cons_streets
edin_road_network <- edin_road_network[edin_road_network@data$LAYER  %in% c("20mph existing streets", "20mph local streets","20mph main streets","30mph","Part time 20mph"),]
edin_road_network <- spTransform(edin_road_network,"+init=epsg:4326")

#Visualize with leaflet
col = c("#bf812d","#80cdc1","#d6604d","#525252","#1a9850","#cab2d6","#e6f598","#4393c3")
#my.palette <- brewer.pal(n = 8, name = "Set3")
spplot(edin_cons_streets,'LAYER',col.regions = col)
leaflet(edin_cons_streets) %>% addTiles() %>% addPolygons()
```

> Edinburgh's implementation zones

```{r,echo=FALSE,warning=FALSE,message=FALSE}
#Read shapefile
edin_impl_zones <- readOGR(dsn = gdb_path, layer="ImplementationZones", verbose = FALSE)
#Transform to long/lat
edin_impl_zones <- spTransform(edin_impl_zones, "+init=epsg:4326")
#Change zone 1
edin_impl_zones@data$ImplementationZone <- as.integer(edin_impl_zones@data$ImplementationZone)
edin_impl_zones@data[6,]$ImplementationZone <- 7
#Visualize with leaflet
#display.brewer.all()
my.palette <- brewer.pal(n = 7, name = "Pastel2")
spplot(edin_impl_zones,"ImplementationZone",col.regions = my.palette, cuts = 7)
leaflet(edin_impl_zones) %>% addTiles() %>% addPolygons()
```

> Edinburgh's control zones

```{r,echo=FALSE,warning=FALSE,message=FALSE}
#Read control zones codes
control_1 <- read.delim(paste0(dir_path, "/control_zone_codes/controlzone1.txt"),stringsAsFactor = FALSE,header = FALSE)
control_3 <- read.delim(paste0(dir_path, "/control_zone_codes/controlzone3.txt"),stringsAsFactor = FALSE,header = FALSE)
control_3 <- c(control_3[,1],control_3[,2],control_3[,3],control_3[,4],control_3[,5],control_3[,6],control_3[,7],control_3[,8],control_3[,9])
control_4 <- read.delim(paste0(dir_path, "/control_zone_codes/controlzone4.txt"),stringsAsFactor = FALSE,header = FALSE)
control_5 <- read.delim(paste0(dir_path, "/control_zone_codes/controlzone5.txt"),stringsAsFactor = FALSE,header = FALSE)
control_6 <- read.delim(paste0(dir_path, "/control_zone_codes/controlzone6.txt"),stringsAsFactor = FALSE,header = FALSE)
control_7 <- read.delim(paste0(dir_path, "/control_zone_codes/controlzone7.txt"),stringsAsFactor = FALSE,header = FALSE)
control_all <- c(control_1,control_3,control_4,control_5,control_6,control_7)

#Path for control zones
control_gdb_path <- paste0(dir_path, "/SG_DataZoneBdry_2011")
control_gdb_layers <- ogrListLayers(control_gdb_path)

#Read data
edin_control_zone <- readOGR(dsn = control_gdb_path,layer="SG_DataZone_Bdry_2011", verbose = FALSE)
edin_control_zone <- spTransform(edin_control_zone, "+init=epsg:4326")
control_zone_all <- edin_control_zone[edin_control_zone@data$DataZone %in%  control_all,]

leaflet(control_zone_all) %>% addTiles() %>% addPolygons()
```


```{r,echo=FALSE,warning=FALSE,message=FALSE} 
#Read data
edin_road_data <- read_road_data()
casualties_data <- read_csv(paste0(dir_path, "/edin_casualties_data.csv"))
#keep a copy
#data <- edin_road_data
#df <- data 
```


```{r, echo=FALSE, warning=FALSE,message=FALSE}
#check problems in longitude/latitude
data0 <- edin_road_data[edin_road_data$Date >= "2016-01-01" & edin_road_data$Date <= "2016-12-31", ]
write.csv(data0, file = paste0(dir_path, "/problems_2016_data.csv"), row.names = FALSE )
leaflet(edin_cons_streets) %>% addTiles() %>% addPolylines() %>% addMarkers(lng =data0$Longitude, lat = data0$Latitude) %>% 
  addCircleMarkers(lng = data0$Longitude.before, lat = data0$Latitude.before )
```

> Time series analysis

```{r, echo=FALSE, warning=FALSE,message=FALSE}
time_plot(edin_road_data)
```

```{r, echo=FALSE, warning=FALSE,message=FALSE}
#Get nearest line for pre and post 20mph using the nearest_line function, use only layers we care edin_road network instead of edin_cons_streets
#nearest_road <- nearest_line(edin_road_data,edin_cons_streets)
#nearest_road <- spTransform(nearest_road,"+init=epsg:4326")
nearest_road <- nearest_line(edin_road_data,edin_road_network)
nearest_road <- spTransform(nearest_road,"+init=epsg:4326")
head(nearest_road[,c(2,37,38)])
```

```{r, echo=FALSE, warning=FALSE,message=FALSE}
#Merge the dataframes based on the ID of the nearest line in order to connect geoinformation with stasts19
#Then merge Casualty severity column with collisions dataset
mergedDf_original <- unique(merge(data.frame(nearest_road),edin_cons_streets@data,by.x = "nearest_line_id" ,by.y = "ID"))
mergedDf <- unique(merge(data.frame(nearest_road),edin_road_network@data,by.x = "nearest_line_id" ,by.y = "ID"))
#mer <- mergedDf [mergedDf$year == "2019",]
#mergedDf <- merge(mergedDf,casualties_data)

#mergedDf$Casualty_Severity <- as.character(mergedDf$Casualty_Severity)
#mergedDf$Casualty_Severity[mergedDf$Casualty_Severity == 1] <- "Fatal"
#mergedDf$Casualty_Severity[mergedDf$Casualty_Severity == 2] <- "Serious"
#mergedDf$Casualty_Severity[mergedDf$Casualty_Severity == 3] <- "Slight"

#acc_sev <- aggregate(data=mergedDf,Casualty_Severity ~ . ,FUN=paste)
#mergedDf <- rbind.fill(mergedDf,mer)
#mergedDf <- unique(rbind.fill(acc_sev,mer))
#casualties_data <- rbind.fill(casualties_data,rd_2019)

mergedDf <- rename(mergedDf,c("Longitude.x" = "Longitude","Latitude.x"="Latitude","year.x"="year","Speed_limit.x"="Speed_limit","Date.x"="Date"))
mergedDf$Date <- as.character(mergedDf$Date)
#mergedA <- mergedDf[,-c(44)]
mergedA <- mergedDf
write.csv(mergedA, file = paste0(dir_path, "/merged_data.csv"), row.names = FALSE )
```

> Mapping accidents with roads: 2013/2014

```{r, echo=FALSE, warning=FALSE,message=FALSE}
leaflet_map(mergedDf[mergedDf$Date >= "2013-07-31" & mergedDf$Date <= "2014-07-30" ,],edin_cons_streets)
count(mergedDf[mergedDf$Date >= "2013-07-31" & mergedDf$Date <= "2014-07-30" ,])
p13 <- count_pre(mergedDf[mergedDf$Date >= "2013-07-31" & mergedDf$Date <= "2014-07-30" ,])
pre13 <- count_post(mergedDf[mergedDf$Date >= "2013-07-31" & mergedDf$Date <= "2014-07-30" ,])
```

> Mapping accidents with roads: 2014/2015

```{r, echo=FALSE, warning=FALSE,message=FALSE}
leaflet_map(mergedDf[mergedDf$Date >= "2014-07-31" & mergedDf$Date <= "2015-07-30" ,],edin_cons_streets)
count(mergedDf[mergedDf$Date >= "2014-07-31" & mergedDf$Date <= "2015-07-30" ,])
p14 <- count_pre(mergedDf[mergedDf$Date >= "2014-07-31" & mergedDf$Date <= "2015-07-30" ,]) 
pre14 <- count_post(mergedDf[mergedDf$Date >= "2014-07-31" & mergedDf$Date <= "2015-07-30" ,])
```

> Mapping accidents with roads: 2015/2016

```{r, echo=FALSE, warning=FALSE,message=FALSE}
leaflet_map(mergedDf[mergedDf$Date >= "2015-07-31" & mergedDf$Date <= "2016-07-20" ,],edin_cons_streets)
count(mergedDf[mergedDf$Date >= "2015-07-31" & mergedDf$Date <= "2016-07-20" ,])
p15 <- count_pre(mergedDf[mergedDf$Date >= "2015-07-31" & mergedDf$Date <= "2016-07-30" ,])
pre15 <- count_post(mergedDf[mergedDf$Date >= "2015-07-31" & mergedDf$Date <= "2016-07-30" ,])
```

> Mapping accidents with roads: 2018/2019

```{r, echo=FALSE, warning=FALSE,message=FALSE}
leaflet_map(mergedDf[mergedDf$year == "2018", ],edin_cons_streets)
count(mergedDf[mergedDf$Date >= "2018-03-06" & mergedDf$Date <= "2019-06-31" ,])
```

> Count pre 20mph 

```{r,echo=FALSE,warning=FALSE,message=FALSE}
pre <- count_pre(mergedDf[mergedDf$Date >= "2013-07-31" & mergedDf$Date <= "2016-07-30" ,])
p <- count_post(mergedDf[mergedDf$Date >= "2013-07-31" & mergedDf$Date <= "2016-07-30" ,])
pre
p
```

> Count post 20mph

```{r,echo=FALSE,warning=FALSE,message=FALSE}
post <- count_pre(mergedDf[mergedDf$Date >= "2018-03-06" & mergedDf$Date <= "2019-06-31" ,])
po <- count_post(mergedDf[mergedDf$Date >= "2018-03-06" & mergedDf$Date <= "2019-06-31" ,])
post
po
```

> Output column: Layer

```{r,echo=FALSE,warning=FALSE,message=FALSE}
head(mergedDf[,c(3,20,40)])
```

> Table: Average annual road traffic collision rates in the city of Edinburgh 

```{r, echo=FALSE, warning=FALSE, message=FALSE}
table_annual(pre,post)
table_police(p,po)
```

> Effect estimate

```{r,echo=FALSE,warning=FALSE,message=FALSE}
a <- sum(pre13[,2])
b <- sum(pre14[,2])
c <- sum(pre15[,2])
d <- sum(po[,2])

Tax_year <- c("Annual number of collisions","Rate per year"," ","% reduction in collisions ")
sum1 <- (a+b+c) / 3
sum2 <- d / 1.33
unadjusted_estimate <-  (sum1 - sum2 ) / sum1  
trend_a <- (a-b)/a 
trend_b <- (b-c)/b
secular_trend <- (trend_a + trend_b) / 2
f <- ( unadjusted_estimate - secular_trend ) * 100

Y_2013_14 <- c(a,a," ", round(f,digits = 2))
Y_2014_15 <- c(b,b," "," ")
Y_2015_16 <- c(c,c," "," ")
Y_2016_17 <- c("Intervention "," "," "," ")
Y_2017_18 <- c("years "," "," "," ")
Y_2018_19 <- c(d, round(sum2,digits = 2)," "," ")

df <- data.frame(Tax_year,Y_2013_14,Y_2014_15,Y_2015_16,Y_2016_17,Y_2017_18,Y_2018_19)
colnames(df) <- c("Tax year", " 2013/14 "," 2014/15 ","  2015/16  ","  2016/17  ","  2017/18  "," 2018/19 ")
kable(df,caption = "Total number of collisions in the city of Edinburgh ", booktabs = TRUE, valign = 't') %>% kable_styling(bootstrap_options =     
c("hover","striped"),font_size = 15 )


calculations <- c("A + B + C / 3 ", "A - B / A", "B - C / B", "Unadjusted_estimate", "Secular_trend" )
column <- c(round(sum1,digits = 2),round(trend_a,digits = 2) * 100, round(trend_b,digits = 2) * 100, round(unadjusted_estimate,digits = 2) *100,round(secular_trend, digits = 2 ) * 100)

df_cal <- data.frame(calculations,column)
colnames(df_cal) <-  c("Calculations", " ")
kable(df_cal) %>% kable_styling(position = "center",bootstrap_options = c("basic","hover","striped"),font_size = 15 )%>%  
    footnote(general = " ", number =c("A : accidents 2013/14 ( 1 year )","B : accidents 2014/15 ( 1 year ) ","C : accidents 2015/16 ( 1 year )","D : accidents 2018/19 ( 16 months )")) 
```
 
> Data used for the implementation and control zones (2013-2018)

```{r,echo=FALSE,warning=FALSE,message=FALSE}
#We add data into edin_road_data and control_zone_data to proceed with implementation zone counting 
#read 2017, part of 2016 & 2018 data

rd <- add_zone_data()
#rd <- rd %>% filter(rd$`Local_Authority_(District)` %in% c("923","910","925","918","935","926")) 
edin_zone_rd <- rd %>% filter(rd$`Local_Authority_(District)` == "923" ) 
control_zone_rd <- rd %>% filter(rd$`Local_Authority_(District)` %in% c("910","925","918","935","926")) 

#rd <-  rename(rd,c("Longitude" = "Longitude before", "Latitude" = "Latitude before")) 
#coord <- rd %>% st_as_sf(coords = c("Location_Easting_OSGR","Location_Northing_OSGR"), crs = 27700) %>% st_transform(4326) %>% st_coordinates() %>% as_tibble()
#rd <- data.frame(rd,coord)
#rd <-  rename(rd,c("X"="Longitude","Y"="Latitude")) 

#edin_rd <-  rename(edin_rd, c("Longitude" = "Longitude before","Latitude" = "Latitude before")) 
#coord <- edin_rd %>% st_as_sf(coords = c("Location_Easting_OSGR","Location_Northing_OSGR"), crs = 27700) %>% st_transform(4326) %>% st_coordinates() %>% #as_tibble()
#edin_zone_rd <- data.frame(edin_zone_rd,coord)
#edin_zone_rd <-  rename(edin_zone_rd,c("X"="Longitude","Y"="Latitude")) 
edin_road_data_1 <- edin_road_data[,-c(35,36)]
edin_road_data_1 <-  rename(edin_road_data,c("Longitude before" = "Longitude", "Latitude before" = "Latitude")) 
edin_zone_data <- rbind.fill(edin_zone_rd,edin_road_data_1)

data1 <- edin_road_data
data1 <- rowid_to_column(data1,"index_ID")
```


```{r,echo=FALSE,warning=FALSE,message=FALSE}
total_zones <- buffer_data(data1,edin_impl_zones)
```


```{r,echo=FALSE,warning=FALSE,message=FALSE}
map_zones <- map_zones(edin_impl_zones)
```

> Mapping accidents with implementation zones : 2013

```{r,echo=FALSE,warning=FALSE,message=FALSE}
total <- total_zones[total_zones$Date >= "2013-07-31" & total_zones$Date <= "2013-12-31" ,]

map_zones %>% addMarkers(lng =total$Longitude, lat = total$Latitude, 
                         popup =paste("Accident index: ", total$Accident_Index, "<br>",
                                      "Zone: ", total$ImplementationZone))

```

> Mapping accidents with implementation zones: 2014

```{r,echo=FALSE,warning=FALSE,message=FALSE}
total <- total_zones[total_zones$Date >= "2014-01-01" & total_zones$Date <= "2014-12-31" ,]

map_zones %>%
  setView(lng = -3.188267 , lat = 55.953251, zoom = 11) %>% 
  addMarkers(lng =total$Longitude, lat = total$Latitude, 
             popup =paste("Accident index: ", total$Accident_Index, "<br>",
                          "Zone: ", total$ImplementationZone))
``` 

> Mapping accidents with implementation zones: 2015

```{r,echo=FALSE,warning=FALSE,message=FALSE}
total <- total_zones[total_zones$Date >= "2015-01-01" & total_zones$Date <= "2015-12-31" ,]

map_zones %>% addMarkers(lng =total$Longitude, lat = total$Latitude, 
                         popup =paste("Accident index: ", total$Accident_Index, "<br>",
                                      "Zone: ", total$ImplementationZone))
```

> Mapping accidents with implementation zones: 2016

```{r, echo=FALSE, warning=FALSE,message=FALSE}
total <- total_zones[total_zones$Date >= "2016-01-01" & total_zones$Date <= "2016-12-31" ,]

map_zones %>% addMarkers(lng =total$Longitude, lat = total$Latitude, 
                         popup =paste("Accident index: ", total$Accident_Index, "<br>",
                                      "Zone: ", total$ImplementationZone))
```

> Mapping accidents with implementation zones: 2017

```{r, echo=FALSE, warning=FALSE,message=FALSE}
total <- total_zones[total_zones$Date >= "2017-01-01" & total_zones$Date <= "2017-12-31" ,]

map_zones %>% addMarkers(lng =total$Longitude, lat = total$Latitude, 
                         popup =paste("Accident index: ", total$Accident_Index, "<br>",
                                      "Zone: ", total$ImplementationZone))
```

> Mapping accidents with implementation zones: 2018

```{r,echo=FALSE,warning=FALSE,message=FALSE}
total <- total_zones[total_zones$Date >= "2018-01-01" & total_zones$Date <= "2018-12-31" ,]

map_zones %>% addMarkers(lng =total$Longitude, lat = total$Latitude, 
                         popup =paste("Accident index: ", total$Accident_Index, "<br>",
                                      "Zone: ", total$ImplementationZone))
```

> Output column: Implementation Zone

```{r,echo=FALSE,warning=FALSE,message=FALSE}
head(total_zones[,c(2,19,40)])
```

> Table: Average annual road traffic collision rates in the city of Edinburgh per implementation zone

```{r,echo=FALSE,warning=FALSE,message=FALSE}
table_zones(total_zones)
```

```{r,echo=FALSE,warning=FALSE,message=FALSE}
control_zone_data <- read_controlzone_data()
control_zone_data <- control_zone_data %>% filter(control_zone_data$`Local_Authority_(District)` %in% c("910","925","918","935","926"))
control_zone_data <- rbind.fill(control_zone_rd,control_zone_data)
control_zone_data$Date <- as.character(control_zone_data$Date)
control_zone_data$`Local_Authority_(District)` <- as.character(control_zone_data$`Local_Authority_(District)` )

```

> Control zone 1a:City center --> George St/Harbour, Aberdeen 

```{r,echo=FALSE,warning=FALSE,message=FALSE}
control_zone_1 <- edin_control_zone[edin_control_zone@data$DataZone %in%  control_1,]
#con_data <- con_data[con_data$Date >= "2013-07-31" & con_data$Date <= "2016-07-31", ]
con_data <- control_zone_data %>% filter(control_zone_data$`Local_Authority_(District)` %in%  c("910"))
con_data <- con_data[con_data$Date >= "2013-07-31" & con_data$Date <= "2016-07-31", ]
control_zone_1a_df <- data.frame(buffer_data(con_data,control_zone_1))
control_zone_1a_df <- cbind(Control_zone = "1a", control_zone_1a_df)
leaflet(control_zone_1) %>% addTiles() %>% addPolygons() %>% addMarkers(lng = control_zone_1a_df$Longitude, lat = control_zone_1a_df$Latitude) %>% setView(lng = -2.099075 , lat = 57.149651, zoom = 13)
nrow(control_zone_1a_df)
```

> Control zone 1b:Rural west --> Tay Bridgehead & St Andrews

```{r,echo=FALSE,warning=FALSE,message=FALSE}
control_zone_7 <- edin_control_zone[edin_control_zone@data$DataZone %in%  control_7,]
con_data <- control_zone_data %>% filter(control_zone_data$`Local_Authority_(District)` %in% c("925"))
con_data <- con_data[con_data$Date >= "2013-07-31" & con_data$Date <= "2016-07-31", ]
control_zone_1b_df <- data.frame(buffer_data(con_data,control_zone_7))
control_zone_1b_df <- cbind(Control_zone = "1b", control_zone_1b_df)
leaflet(control_zone_7) %>% addTiles() %>% addPolygons()%>% addMarkers(lng = control_zone_1b_df$Longitude, lat = control_zone_1b_df$Latitude) %>% setView(lng = -2.8833 , lat = 56.3833, zoom = 11)
nrow(control_zone_1b_df)
```

> Control zone 3:South central --> Dundee

```{r,echo=FALSE,warning=FALSE,message=FALSE}
control_zone_3 <- edin_control_zone[edin_control_zone@data$DataZone %in%  control_3,]
con_data <- control_zone_data %>% filter(control_zone_data$`Local_Authority_(District)` %in% c("918"))
con_data <- con_data[con_data$Date >= "2014-02-28" & con_data$Date <= "2017-02-28", ]
control_zone_3_df <- data.frame(buffer_data(con_data,control_zone_3))
control_zone_3_df <- cbind(Control_zone = "3", control_zone_3_df)
leaflet(control_zone_3) %>% addTiles() %>% addPolygons() %>% addMarkers(lng = control_zone_3_df$Longitude, lat = control_zone_3_df$Latitude)
nrow(control_zone_3_df)
```

> Control zone 4:North west -> Renfrew North, Renfrew South & Gallowhill, Paisley North West

```{r,echo=FALSE,warning=FALSE,message=FALSE}
control_zone_4 <- edin_control_zone[edin_control_zone@data$DataZone %in%  control_4,]
con_data <- control_zone_data %>% filter(control_zone_data$`Local_Authority_(District)` %in% c("935"))
con_data <- con_data[con_data$Date >= "2014-08-16" & con_data$Date <= "2017-08-16", ]
control_zone_4_df <- data.frame(buffer_data(con_data,control_zone_4))
control_zone_4_df <- cbind(Control_zone = "4", control_zone_4_df)
leaflet(control_zone_4) %>% addTiles() %>% addPolygons()%>% addMarkers(lng = control_zone_4_df$Longitude, lat = control_zone_4_df$Latitude)
nrow(control_zone_4_df)
```

> Control zone 5:West --> Glasgow Kelvin

```{r,echo=FALSE,warning=FALSE,message=FALSE}
control_zone_5 <- edin_control_zone[edin_control_zone@data$DataZone %in%  control_5,]        
con_data <- control_zone_data %>% filter(control_zone_data$`Local_Authority_(District)` %in% c("926"))
con_data <- con_data[con_data$Date >= "2014-08-16" & con_data$Date <= "2017-08-16", ]
control_zone_5_df <- data.frame(buffer_data(con_data,control_zone_5))
control_zone_5_df <- cbind(Control_zone = "5", control_zone_5_df)
leaflet(control_zone_5) %>% addTiles() %>% addPolygons()%>% addMarkers(lng = control_zone_5_df$Longitude, lat = control_zone_5_df$Latitude) %>% setView(lng = -4.25763 , lat = 55.86515, zoom = 12)
nrow(control_zone_5_df)
```

> Control zone 6:South --> Paisley

```{r,echo=FALSE,warning=FALSE,message=FALSE}
control_zone_6 <- edin_control_zone[edin_control_zone@data$DataZone %in%  control_6,]    
con_data <- control_zone_data %>% filter(control_zone_data$`Local_Authority_(District)` %in% c("935"))
con_data <- con_data[con_data$Date >= "2015-03-05" & con_data$Date <= "2018-03-05", ]
control_zone_6_df <- data.frame(buffer_data(con_data,control_zone_6))
control_zone_6_df <- cbind(Control_zone = "6", control_zone_6_df)
leaflet(control_zone_6) %>% addTiles() %>% addPolygons() %>% addMarkers(lng = control_zone_6_df$Longitude, lat = control_zone_6_df$Latitude)
nrow(control_zone_6_df) 
```

> Updated dataset for Edinburgh

```{r,echo=FALSE,warning=FALSE,message=FALSE}
#final_dataset
#control zones data
control_zones_df <-rbind.fill(control_zone_1a_df,control_zone_1b_df,control_zone_3_df,control_zone_4_df,control_zone_5_df,control_zone_6_df)
merged_1 <- mergedDf[,-c(35:38,39)]
total_zones_1 <- total_zones[,-c(1,3:34)]
updated_dataset <- merge(merged_1,total_zones_1,by.x = "Accident_Index",by.y = "Accident_Index")
updated_dataset <-updated_dataset[,-c(2,3,36)]
final_df <- rbind.fill(updated_dataset,control_zones_df)
final_df <- final_df[,-c(33:34,40:45)]
head(updated_dataset[,c(1,18,32,35)])
#Create new csv file with the cleaned data
write.csv(final_df, file = paste0(dir_path, "/final_Edinburgh_data.csv"),row.names=FALSE)

```

