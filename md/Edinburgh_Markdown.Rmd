---
title: "Edinburgh Markdown"
output: html_document
---

```{r,echo=FALSE,warning=FALSE,message=FALSE}
# Load libraries
library(rgdal)
library(leaflet)
library(tidyverse)
library(rgeos)
library(raster)
library(ggplot2)
library(sf)
library(mapview)
library(maptools)
library(sp)
library(readxl)
library(readr)
library(grid)
library(gridExtra)
library(xtable)
library(knitr)
library(kableExtra)
library(plyr)
library(RColorBrewer)

#1.Function for keeping data of Edinburgh with speed limits 20/30/40
filter_data <- function(data){
  data <- data %>% filter(data$Speed_limit %in% c(20,30,40)) 
  data <- data %>% filter(data$`Local_Authority_(District)` == 923)
  #data$Date <- as.Date(data$Date,format="%d/%m/%Y")
  data <- na.omit(data[1:31])#remove NA obs
  return(data)
}

#2.Function for deleting Na points
delete_na <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}

#Count function
count <- function(data_df){
  count1 <- aggregate(Accident_Index~LAYER,data_df,length)
  count2 <- aggregate(Accident_Index~Speed_limit,data_df,length)
  print(count1)
  print(count2)
}

#Count accidents per layer
count_pre <- function(data_df){
  count1 <-  aggregate(Accident_Index~LAYER,data_df,length)
  return(count1)
}

#Count accidents per speed limit
count_post <- function(data_df){
  count1 <-  aggregate(Accident_Index~Speed_limit,data_df,length)
  return(count1)
}

#Count accidents per zone
count_impl <- function(data_df){
  count1 <- aggregate(Accident_Index~ImplementationZone,data_df,length)
  print(count1)
  return(count1)
}

source('../functions/localSnapPointsToLines.R')
source('../functions/nearest_line.R')
source('../functions/leaflet_map.R')

##1.Data path 
dir_path <- "../data"
```

> Edinburgh's road network

```{r,echo=FALSE,warning=FALSE,message=FALSE} 
#Data inputs

#2.Gis 
#Read geodatabase for Edinburgh
#Path
gdb_path <- paste0(dir_path, "/20mph.gdb")
gdb_layers <- ogrListLayers(gdb_path)

#Read shapefile
edin_cons_streets <- readOGR(dsn = gdb_path,layer="Consultation20mphStreets", verbose = FALSE)
#Put ID column as variable 
edin_cons_streets@data <-rowid_to_column(edin_cons_streets@data, "ID")
#Transform to long/lat
edin_cons_streets <- spTransform(edin_cons_streets, "+init=epsg:4326")

edin_road_network <- edin_cons_streets

#edin_road_network@data$LAYER <- as.character(edin_road_network@data$LAYER)
#edin_road_network <- st_as_sf(edin_road_network)
edin_road_network <- edin_road_network[edin_road_network@data$LAYER  %in% c("20mph existing streets", "20mph local streets","20mph main streets","30mph"),]

edin_road_network <- spTransform(edin_road_network,"+init=epsg:4326")
#nearest_road2 <- nearest_line(edin_road_data,edin_road_network)

leaflet(edin_road_network) %>% addTiles() %>% addPolylines(popup=edin_road_network$LAYER)

#Visualize with leaflet
#col = c("#bf812d","#80cdc1","#d6604d","#525252","#1a9850","#cab2d6","#e6f598","#4393c3")
#my.palette <- brewer.pal(n = 8, name = "Set3")
#spplot(edin_cons_streets,'LAYER',col.regions = col)
leaflet(edin_cons_streets) %>% addTiles() %>% addPolygons()
```

> Edinburgh's implementation zones

```{r,echo=FALSE,warning=FALSE,message=FALSE}
#Read shapefile
edin_impl_zones <- readOGR(dsn = gdb_path, layer="ImplementationZones", verbose = FALSE)
#Transform to long/lat
edin_impl_zones <- spTransform(edin_impl_zones, "+init=epsg:4326")
#Change zone 1
edin_impl_zones@data$ImplementationZone <- as.integer(edin_impl_zones@data$ImplementationZone)
edin_impl_zones@data[6,]$ImplementationZone <- 7
#Visualize with leaflet
#display.brewer.all()
my.palette <- brewer.pal(n = 7, name = "Pastel2")
spplot(edin_impl_zones,"ImplementationZone",col.regions = my.palette, cuts = 7)
leaflet(edin_impl_zones) %>% addTiles() %>% addPolygons()
```

> Edinburgh's control zones

```{r,echo=FALSE,warning=FALSE,message=FALSE}
#Read control zones codes
control_1 <- read.delim(paste0(dir_path, "/control_zone_codes/controlzone1.txt"),stringsAsFactor = FALSE,header = FALSE)
control_3 <- read.delim(paste0(dir_path, "/control_zone_codes/controlzone3.txt"),stringsAsFactor = FALSE,header = FALSE)
control_3 <- c(control_3[,1],control_3[,2],control_3[,3],control_3[,4],control_3[,5],control_3[,6],control_3[,7],control_3[,8],control_3[,9])
control_4 <- read.delim(paste0(dir_path, "/control_zone_codes/controlzone4.txt"),stringsAsFactor = FALSE,header = FALSE)
control_5 <- read.delim(paste0(dir_path, "/control_zone_codes/controlzone5.txt"),stringsAsFactor = FALSE,header = FALSE)
control_6 <- read.delim(paste0(dir_path, "/control_zone_codes/controlzone6.txt"),stringsAsFactor = FALSE,header = FALSE)
control_7 <- read.delim(paste0(dir_path, "/control_zone_codes/controlzone7.txt"),stringsAsFactor = FALSE,header = FALSE)
control_all <- c(control_1,control_3,control_4,control_5,control_6,control_7)

#Path for control zones
control_gdb_path <- paste0(dir_path, "/SG_DataZoneBdry_2011")
control_gdb_layers <- ogrListLayers(control_gdb_path)

#Read data
edin_control_zone <- readOGR(dsn = control_gdb_path,layer="SG_DataZone_Bdry_2011", verbose = FALSE)
edin_control_zone <- spTransform(edin_control_zone, "+init=epsg:4326")

control_zone_all <- edin_control_zone[edin_control_zone@data$DataZone %in%  control_all,]

leaflet(control_zone_all) %>% addTiles() %>% addPolygons()

```


```{r,echo=FALSE,warning=FALSE,message=FALSE} 
#Read data
edin_road_data <- read_csv(paste0(dir_path, "/edin_road_data.csv"))
edin_road_data <- edin_road_data %>% filter(edin_road_data$Speed_limit %in% c(20,30)) 
control_zone_data <- read_csv(paste0(dir_path, "/edin_control_data.csv"))
control_zone_data <- control_zone_data %>% filter(control_zone_data$Speed_limit %in% c(20,30)) 
casualties_data <- read_csv(paste0(dir_path, "/edin_casualties_data.csv"))
rd_2019 <- read_csv(paste0(dir_path, "/data2019.csv"))
rd_2019 <- rd_2019 %>% filter(rd_2019$Speed_limit %in% c(20,30)) 

edin_road_data <- edin_road_data %>% mutate(year = format(as.Date(edin_road_data$Date, format="%m/%d/%Y"),"%Y"))
edin_road_data <- rbind.fill(edin_road_data,rd_2019)

#keep a copy for implementation zones
data <- edin_road_data
edin_road_data <-rowid_to_column(edin_road_data, "ID")

df <- data
data <- rowid_to_column(data,"index_ID")
```

> Time series analysis

```{r, echo=FALSE, warning=FALSE,message=FALSE}
ggplot(edin_road_data) +
 aes(x = Speed_limit) +
 geom_histogram(bins = 30L, fill = "#a6d96a") +
 theme_minimal() +
 facet_wrap(vars(year))

ggplot(edin_road_data) +
 aes(x = Date, colour = Speed_limit) +
 geom_histogram(bins = 30L, fill = "#a6d96a") +
 scale_color_distiller(palette = "Greens") +
 theme_minimal()

ggplot(edin_road_data) +
 aes(x = Date, weight = Speed_limit) +
 geom_bar(fill = "#1a9850") +
 theme_minimal()
```


```{r, echo=FALSE, warning=FALSE,message=FALSE}
#Data manipulation
#Get nearest line for pre and post 20mph using the nearest_line function 

#nearest_road <- nearest_line(edin_road_data,edin_cons_streets)
#nearest_road <- spTransform(nearest_road,"+init=epsg:4326")
nearest_road <- nearest_line(edin_road_data,edin_road_network)
nearest_road <- spTransform(nearest_road,"+init=epsg:4326")

```

```{r, echo=FALSE, warning=FALSE,message=FALSE}
#Merge the dataframes based on the ID of the nearest line in order to connect geoinformation with stasts19
#Then merge Casualty severity column with collisions dataset
mergedDf_original <- unique(merge(data.frame(nearest_road),edin_cons_streets@data,by.x = "nearest_line_id" ,by.y = "ID"))
mergedDf <- unique(merge(data.frame(nearest_road),edin_road_network@data,by.x = "nearest_line_id" ,by.y = "ID"))
mer <- mergedDf [mergedDf$year == "2019",]
mergedDf <- merge(mergedDf,casualties_data)


mergedDf$Casualty_Severity <- as.character(mergedDf$Casualty_Severity)
mergedDf$Casualty_Severity[mergedDf$Casualty_Severity == 1] <- "Fatal"
mergedDf$Casualty_Severity[mergedDf$Casualty_Severity == 2] <- "Serious"
mergedDf$Casualty_Severity[mergedDf$Casualty_Severity == 3] <- "Slight"

acc_sev <- aggregate(data=mergedDf,Casualty_Severity ~ . ,FUN=paste)
mergedDf <- rbind.fill(mergedDf,mer)
mergedDf <- unique(rbind.fill(acc_sev,mer))
#casualties_data <- rbind.fill(casualties_data,rd_2019)

mergedDf <- rename(mergedDf,c("Longitude.x" = "Longitude","Latitude.x"="Latitude","year.x"="year","Speed_limit.x"="Speed_limit","Date.x"="Date"))
```

> Mapping accidents with roads: 2013

```{r, echo=FALSE, warning=FALSE,message=FALSE}
leaflet_map(mergedDf[mergedDf$year == "2013", ],edin_road_data[edin_road_data$year == "2013", ],edin_cons_streets)
count(mergedDf[mergedDf$year == "2013", ])
p13 <- count_pre(mergedDf[mergedDf$Date >= "2013-07-31" & mergedDf$Date <= "2014-07-30" ,])
pre13 <- count_post(mergedDf[mergedDf$Date >= "2013-07-31" & mergedDf$Date <= "2014-07-30" ,])
```

> Mapping accidents with roads: 2014

```{r, echo=FALSE, warning=FALSE,message=FALSE}
leaflet_map(mergedDf[mergedDf$year == "2014", ],edin_road_data[edin_road_data$year == "2014", ],edin_cons_streets)
count(mergedDf[mergedDf$year == "2014", ])
p14 <- count_pre(mergedDf[mergedDf$Date >= "2014-07-31" & mergedDf$Date <= "2015-07-30" ,])
pre14 <- count_post(mergedDf[mergedDf$Date >= "2014-07-31" & mergedDf$Date <= "2015-07-30" ,])
```

> Mapping accidents with roads: 2015

```{r, echo=FALSE, warning=FALSE,message=FALSE}
leaflet_map(mergedDf[mergedDf$year == "2015", ],edin_road_data[edin_road_data$year == "2015", ],edin_cons_streets)
count(mergedDf[mergedDf$year == "2015", ])
p15 <- count_pre(mergedDf[mergedDf$Date >= "2015-07-31" & mergedDf$Date <= "2016-07-20" ,])
pre15 <- count_post(mergedDf[mergedDf$Date >= "2015-07-31" & mergedDf$Date <= "2016-07-20" ,])
```

> Mapping accidents with roads: 2016

```{r, echo=FALSE, warning=FALSE,message=FALSE}
leaflet_map(mergedDf[mergedDf$year == "2016", ],edin_road_data[edin_road_data$year == "2016", ],edin_cons_streets)
count(mergedDf[mergedDf$year == "2016", ])

```

> Mapping accidents with roads: 2018

```{r, echo=FALSE, warning=FALSE,message=FALSE}
leaflet_map(mergedDf[mergedDf$year == "2018", ],edin_road_data[edin_road_data$year == "2018", ],edin_cons_streets)
count(mergedDf[mergedDf$year == "2018", ])
```

> Mapping accidents with roads: 2019

```{r, echo=FALSE, warning=FALSE, message=FALSE}
leaflet_map(mergedDf[mergedDf$year == "2019", ],edin_road_data[edin_road_data$year == "2019", ],edin_cons_streets)
count(mergedDf[mergedDf$year == "2019", ])
```

> Count pre 20mph 

```{r,echo=FALSE,warning=FALSE,message=FALSE}
#No 2016
pre <- count_pre(mergedDf[mergedDf$Date >= "2013-07-31" & mergedDf$Date <= "2016-07-20" ,])
p <- count_post(mergedDf[mergedDf$Date >= "2013-07-31" & mergedDf$Date <= "2016-07-20" ,])
pre
p
```

> Count post 20mph

```{r,echo=FALSE,warning=FALSE,message=FALSE}
post0 <- count_pre(mergedDf[mergedDf$year == "2018", ]) 
post <- count_pre(mergedDf[mergedDf$year == "2018", ]) + count_pre(mergedDf[mergedDf$year == "2019", ])
post$LAYER <- as.character(post0$LAYER)
po <- count_post(mergedDf[mergedDf$year == "2018", ]) + count_post(mergedDf[mergedDf$year == "2019", ])
po$Speed_limit <- p$Speed_limit
post
po
```

> Output column: Layer

```{r,echo=FALSE,warning=FALSE,message=FALSE}
head(mergedDf[,c(3,20,40)])
```

> Table: Average annual road traffic collision rates in the city of Edinburgh (GIS)

```{r, echo=FALSE, warning=FALSE, message=FALSE}
#count streets that have changed from 30 to 20mph
s1 <- pre[pre$LAYER == "20mph main streets",2] + pre[pre$LAYER == "20mph local streets",2]
s2 <- post[post$LAYER == "20mph main streets",2] + post[post$LAYER == "20mph local streets",2]

#sum all streets pre and post
sum_pre <-sum(pre[pre$LAYER == "30mph",2],pre[pre$LAYER == "20mph existing streets",2],s1)
sum_post <-sum(post[post$LAYER == "30mph",2],post[post$LAYER == "20mph existing streets",2],s2)

#create column pre and post
collisions_pre_20mph <- c(pre[pre$LAYER == "30mph",2],pre[pre$LAYER == "20mph existing streets",2],s1,sum_pre)
collisions_post_20mph <- c(post[post$LAYER == "30mph",2],post[post$LAYER == "20mph existing streets",2],s2,sum_post)

#rate per year
rate_pre_20mph <- round(collisions_pre_20mph/3,2)
rate_post_20mph <- round(collisions_post_20mph/1,2)

diff_in_rates <- - rate_pre_20mph + rate_post_20mph
percentage_diff_in_rates <- round(diff_in_rates/rate_pre_20mph,2) 

type <- c("Streets at 30mph","Streets at 20mph","Streets at 30mph changed to 20mph","All streets")
df <- data.frame(type,collisions_pre_20mph,collisions_post_20mph,rate_pre_20mph,rate_post_20mph,diff_in_rates,percentage_diff_in_rates*100)
colnames(df)=c("Type", "collisions pre-20mph","collisions post-20mph","rate pre-20mph", "rate post-20mph","diff in rates", "Perc.diff.rates")
kable(df,caption = "Table 1: Average annual road traffic collision rates in the city of Edinburgh (GIS)") %>% kable_styling(bootstrap_options = c("striped", "hover"))
```

> Table: Average annual road traffic collision rates in the city of Edinburgh (Stats19)

```{r,echo=FALSE,warning=FALSE,message=FALSE}

sum_pre_2 <-sum(p[p$Speed_limit == 20,2],p[p$Speed_limit == 30,2])
sum_post_2 <-sum(po[po$Speed_limit == 20,2],po[po$Speed_limit == 30,2])

collisions_pre_20mph <- c(p[p$Speed_limit == 20,2],p[p$Speed_limit == 30,2],sum_pre_2)
collisions_post_20mph <- c(po[po$Speed_limit == 20,2],po[po$Speed_limit == 30,2],sum_post_2)

rate_pre_20mph <- round(collisions_pre_20mph/3,2)
rate_post_20mph <- round(collisions_post_20mph/1,2)

diff_in_rates <- - rate_pre_20mph + rate_post_20mph
percentage_diff_in_rates <- round(diff_in_rates/rate_pre_20mph,2)

type <- c("Streets at 20mph","Streets at 30mph","All streets")
df <- data.frame(type,collisions_pre_20mph,collisions_post_20mph,rate_pre_20mph,rate_post_20mph,diff_in_rates,percentage_diff_in_rates * 100)
colnames(df)=c("Type", "collisions pre-20mph","collisions post-20mph","rate pre-20mph", "rate post-20mph","diff in rates", "Perc.diff.rates")

kable(df,caption = "Table 2: Average annual road traffic collision rates in the city of Edinburgh (Stats19)") %>% kable_styling(bootstrap_options = c("striped", "hover"))

```

> Effect estimate (GIS)

```{r,echo=FALSE,warning=FALSE,message=FALSE}
Tax_year <- c("Annual number of collisions"," ","Effect estimate ")
a <- sum(pre13[,2])
b <- sum(pre14[,2])
c <- sum(pre15[,2])
d <- sum(po[,2])
e <- 0

sum1 <- (a+b+c)/3
sum2 <- d
unadjusted_estimate <-  (sum1 - sum2 ) / sum1  
secular_trend <- ((a-b)/a  + (b-c)/b)/2
f <- ( unadjusted_estimate - secular_trend ) * 100

Y_2013_14 <- c(a," ", round(f,digits = 2))
Y_2014_15 <- c(b," "," ")
Y_2015_16 <- c(c," "," ")
Y_2018_19 <- c(d," "," ")

df <- data.frame(Tax_year,Y_2013_14,Y_2014_15,Y_2015_16,Y_2018_19)
colnames(df)=c("Tax year", "2013/14","2014/15","2015/16", "2018/19")

kable(df,caption = "Effect estimate(GIS)") %>% kable_styling(bootstrap_options = c("striped", "hover"))
```

> Effect estimate (Stats19)

```{r,echo=FALSE,warning=FALSE,message=FALSE}
Tax_year <- c("Annual number of collisions"," ","Effect estimate ")
a <- sum(p13[1:5,2])
b <- sum(p14[1:5,2])
c <- sum(p15[1:5,2])
d <- sum(post[1:5,2])

sum1 <- (a+b+c)/3
sum2 <- d
unadjusted_estimate <-  (sum1 - sum2 ) / sum1  
secular_trend <- ((a-b)/a  + (b-c)/b)/2
f <- ( unadjusted_estimate - secular_trend ) * 100

Y_2013_14 <- c(a," ", round(f,digits = 2))
Y_2014_15 <- c(b," "," ")
Y_2015_16 <- c(c," "," ")
Y_2018_19 <- c(d," "," ")
df <- data.frame(Tax_year,Y_2013_14,Y_2014_15,Y_2015_16,Y_2018_19)
colnames(df)=c("Tax year", "2013/14","2014/15","2015/16", "2018/19")

kable(df,caption = "Effect estimate(Stats19)") %>% kable_styling(bootstrap_options = c("striped", "hover"))
```


```{r,echo=FALSE,warning=FALSE,message=FALSE}
#Create planar(cartesian) projection 
crs <- CRS( "+proj=utm +zone=32 +ellps=WGS72 +units=m +no_defs")     # UTM zone = 32 N
wgs84 <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")  # long/lat

#Convert data to planar projection  
edin_impl_zones <- spTransform(edin_impl_zones,crs)
utm_data <-  spTransform(SpatialPointsDataFrame(coords = data[5:6],proj4string = wgs84,data = data), crs)

proj4string(utm_data) <- proj4string(edin_impl_zones)

#add a buffer around the point
points_polygons <- gBuffer(utm_data, width=6, byid = TRUE )
count_zones <- over(points_polygons,edin_impl_zones,returnList = FALSE)
count_zones <- rowid_to_column(count_zones,"ID")

total_zones <- merge(data,count_zones,by.x="index_ID",by.y="ID")
df_zones <-data.frame(total_zones[2],total_zones[19],total_zones[36])

#Convert data projections back to lat/long to plot with leaflet
edin_impl_zones <- spTransform(edin_impl_zones,"+init=epsg:4326")
#total_zones <- spTransform(total_zones, "+init=epsg:4326")
utm_data <- spTransform(utm_data, "+init=epsg:4326")
#delete_na()
#df_na <- na.omit(df_zones[1:4]) # check how many are missing
```

> Mapping accidents with implementation zones: 2013

```{r,echo=FALSE,warning=FALSE,message=FALSE}

edin_impl_zones <- st_as_sf(edin_impl_zones)
#Leaflet maps of the zones & accidents
zone_1 <- filter(edin_impl_zones,edin_impl_zones$ImplementationZone == 1)
zone_2 <- filter(edin_impl_zones,edin_impl_zones$ImplementationZone == 2)
zone_3 <- filter(edin_impl_zones,edin_impl_zones$ImplementationZone == 3)
zone_4 <- filter(edin_impl_zones,edin_impl_zones$ImplementationZone == 4)
zone_5 <- filter(edin_impl_zones,edin_impl_zones$ImplementationZone == 5)
zone_6 <- filter(edin_impl_zones,edin_impl_zones$ImplementationZone == 6)
zone_7 <- filter(edin_impl_zones,edin_impl_zones$ImplementationZone == 7)

#Visualize
map_zones <- leaflet() %>% addTiles() %>% 
  addPolygons(data = zone_1, color= "green",group = " zone 1 ")%>%
  addPolygons(data = zone_2,color= "red",group = " zone 2 ")%>%
  addPolygons(data = zone_3,color= "purpl",group = " zone 3 ") %>%
  addPolygons(data = zone_4,color= "cyan",group = " zone 4 ")%>%
  addPolygons(data = zone_5,color= "blue",group = " zone 5 ")%>%
  addPolygons(data = zone_6,color= "orange",group = " zone 6 ")%>%
  addPolygons(data = zone_7,color= "black",group = " zone 7 ") %>% 
addLayersControl(overlayGroups = c( " zone 1 "," zone 2 "," zone 3 "," zone 4 "," zone 5 "," zone 6 "," zone 7 "),
                                    options = layersControlOptions(collapsed = FALSE))

map_zones <- map_zones %>% addLegend("bottomright",colors =c("green",  "red","purple", "cyan", "blue","orange","black"),
                      labels= c("1(1a):City Centre", "2:North","3:South Central/East","4:North West","5:West", "6:South","7(1b):Rural West"),
                      title= "Implementation zones",opacity = 1) %>% setView(lng = -3.188267 , lat = 55.953251, zoom = 11)

total <- total_zones[total_zones$year == "2013", ]

map_zones %>% addMarkers(lng =total$Longitude, lat = total$Latitude, 
                         popup =paste("Accident index: ", total$Accident_Index, "<br>",
                                      "Zone: ", total$ImplementationZone))
s_13 <- count_impl(total[total$year == "2013", ])
```

> Mapping accidents with implementation zones: 2014

```{r,echo=FALSE,warning=FALSE,message=FALSE}
total <- total_zones[total_zones$year == "2014", ]

map_zones %>%
  setView(lng = -3.188267 , lat = 55.953251, zoom = 11) %>%
  addMarkers(lng =total$Longitude, lat = total$Latitude, 
             popup =paste("Accident index: ", total$Accident_Index, "<br>",
                          "Zone: ", total$ImplementationZone))
s_14 <- count_impl(total[total$year == "2014", ])
``` 

> Mapping accidents with implementation zones: 2015

```{r,echo=FALSE,warning=FALSE,message=FALSE}
total <- total_zones[total_zones$year == "2015", ]

map_zones %>% addMarkers(lng =total$Longitude, lat = total$Latitude, 
                         popup =paste("Accident index: ", total$Accident_Index, "<br>",
                                      "Zone: ", total$ImplementationZone))
s_15 <- count_impl(total[total$year == "2015", ])
```

> Mapping accidents with implementation zones: 2016

```{r, echo=FALSE, warning=FALSE,message=FALSE}
total <- total_zones[total_zones$year == "2016", ]

map_zones %>% addMarkers(lng =total$Longitude, lat = total$Latitude, 
                         popup =paste("Accident index: ", total$Accident_Index, "<br>",
                                      "Zone: ", total$ImplementationZone))
s_16 <- count_impl(total[total$year == "2016", ])
```

> Mapping accidents with implementation zones: 2018

```{r,echo=FALSE,warning=FALSE,message=FALSE}
total <- total_zones[total_zones$year == "2018", ]

map_zones %>% addMarkers(lng =total$Longitude, lat = total$Latitude, 
                         popup =paste("Accident index: ", total$Accident_Index, "<br>",
                                      "Zone: ", total$ImplementationZone))
s_18 <- count_impl(total[total$year == "2018", ])
```

> Mapping accidents with implementation zones: 2019

```{r, echo=FALSE, warning=FALSE,message=FALSE}
total <- total_zones[total_zones$year == "2019", ]

map_zones %>% addMarkers(lng =total$Longitude, lat = total$Latitude, 
                         popup =paste("Accident index: ", total$Accident_Index, "<br>",
                                      "Zone: ", total$ImplementationZone))
s_19 <- count_impl(total[total$year == "2019", ])
```

> Output column: Implementation Zone

```{r,echo=FALSE,warning=FALSE,message=FALSE}
head(df_zones)
```

> Total accidents per zone

```{r, echo=FALSE, warning=FALSE, message=FALSE}
s <- s_13 + s_14 + s_15 + s_16 + s_18 + s_19 
s$ImplementationZone <- s_13$ImplementationZone 
s
```


```{r,echo=FALSE,warning=FALSE,message=FALSE}
buffer_data <-function(data,zone){
  #Create planar(cartesian) projection 
  crs <- CRS( "+proj=utm +zone=32 +ellps=WGS72 +units=m +no_defs")     # UTM zone = 32 N
  wgs84 <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")  # long/lat
  
  zone <- spTransform(zone,crs)
  data <-  spTransform(SpatialPointsDataFrame(coords = data[4:5],proj4string = wgs84,data = data), crs)
  
  proj4string(data) <- proj4string(zone)
  counts2 <- raster::intersect(data,zone) 
  return(counts2@data)
}
```

> Control zone 1a:City center --> George St/Harbour, Aberdeen 

```{r,echo=FALSE,warning=FALSE,message=FALSE}
control_zone_1 <- edin_control_zone[edin_control_zone@data$DataZone %in%  control_1,]
con_data <- control_zone_data %>% filter(control_zone_data$`Local_Authority_(District)` %in% c("910"))
control_zone_1a_df <- data.frame(buffer_data(con_data,control_zone_1))
control_zone_1a_df <- cbind(Control_zone = "1a", control_zone_1a_df)
leaflet(control_zone_1) %>% addTiles() %>% addPolygons() %>% addMarkers(lng = control_zone_1a_df$Longitude, lat = control_zone_1a_df$Latitude) %>% setView(lng = -2.099075 , lat = 57.149651, zoom = 11)
nrow(control_zone_1a_df)
```

> Control zone 1b:Rural west --> Tay Bridgehead & St Andrews

```{r,echo=FALSE,warning=FALSE,message=FALSE}
control_zone_7 <- edin_control_zone[edin_control_zone@data$DataZone %in%  control_7,]
con_data <- control_zone_data %>% filter(control_zone_data$`Local_Authority_(District)` %in% c("925"))
control_zone_1b_df <- data.frame(buffer_data(con_data,control_zone_7))
control_zone_1b_df <- cbind(Control_zone = "1b", control_zone_1b_df)
leaflet(control_zone_7) %>% addTiles() %>% addPolygons()%>% addMarkers(lng = control_zone_1b_df$Longitude, lat = control_zone_1b_df$Latitude) %>% setView(lng = -2.8833 , lat = 56.3833, zoom = 11)
nrow(control_zone_1b_df)
```

> Control zone 3:South central --> Dundee

```{r,echo=FALSE,warning=FALSE,message=FALSE}
control_zone_3 <- edin_control_zone[edin_control_zone@data$DataZone %in%  control_3,]
con_data <- control_zone_data %>% filter(control_zone_data$`Local_Authority_(District)` %in% c("918"))
control_zone_3_df <- data.frame(buffer_data(con_data,control_zone_3))
control_zone_3_df <- cbind(Control_zone = "3", control_zone_3_df)
leaflet(control_zone_3) %>% addTiles() %>% addPolygons() %>% addMarkers(lng = control_zone_3_df$Longitude, lat = control_zone_3_df$Latitude)
nrow(control_zone_3_df)
```

> Control zone 4:North west -> Renfrew North, Renfrew South & Gallowhill, Paisley North West

```{r,echo=FALSE,warning=FALSE,message=FALSE}
control_zone_4 <- edin_control_zone[edin_control_zone@data$DataZone %in%  control_4,]
con_data <- control_zone_data %>% filter(control_zone_data$`Local_Authority_(District)` %in% c("935"))
control_zone_4_df <- data.frame(buffer_data(con_data,control_zone_4))
control_zone_4_df <- cbind(Control_zone = "4", control_zone_4_df)
leaflet(control_zone_4) %>% addTiles() %>% addPolygons()%>% addMarkers(lng = control_zone_4_df$Longitude, lat = control_zone_4_df$Latitude)
nrow(control_zone_4_df)
```

> Control zone 5:West --> Glasgow Kelvin

```{r,echo=FALSE,warning=FALSE,message=FALSE}
control_zone_5 <- edin_control_zone[edin_control_zone@data$DataZone %in%  control_5,]        
con_data <- control_zone_data %>% filter(control_zone_data$`Local_Authority_(District)` %in% c("926"))
control_zone_5_df <- data.frame(buffer_data(con_data,control_zone_5))
control_zone_5_df <- cbind(Control_zone = "5", control_zone_5_df)
leaflet(control_zone_5) %>% addTiles() %>% addPolygons()%>% addMarkers(lng = control_zone_5_df$Longitude, lat = control_zone_5_df$Latitude) %>% setView(lng = -4.25763 , lat = 55.86515, zoom = 12)
nrow(control_zone_5_df)
```

> Control zone 6:South --> Paisley

```{r,echo=FALSE,warning=FALSE,message=FALSE}
control_zone_6 <- edin_control_zone[edin_control_zone@data$DataZone %in%  control_6,]    
con_data <- control_zone_data %>% filter(control_zone_data$`Local_Authority_(District)` %in% c("935"))
control_zone_6_df <- data.frame(buffer_data(con_data,control_zone_6))
control_zone_6_df <- cbind(Control_zone = "6", control_zone_6_df)
leaflet(control_zone_6) %>% addTiles() %>% addPolygons() %>% addMarkers(lng = control_zone_6_df$Longitude, lat = control_zone_6_df$Latitude)
nrow(control_zone_5_df)
```

> Updated dataset for Edinburgh

```{r,echo=FALSE,warning=FALSE,message=FALSE}
#final_dataset
#control zones data
control_zones_df <-rbind(control_zone_1a_df,control_zone_1b_df,control_zone_3_df,control_zone_4_df,control_zone_5_df,control_zone_6_df)
merged_1 <- mergedDf[,-c(34:38,39)]
total_zones_1 <- total_zones[,-c(1,3:34)]
updated_dataset <- merge(merged_1,total_zones_1,by.x="Accident_Index",by.y="Accident_Index")
updated_dataset <-updated_dataset[,-c(2,3,36)]
final_df <- rbind.fill(updated_dataset,control_zones_df,by.x="Accident_Index",by.y="Accident_Index")
head(updated_dataset[,c(1,18,32,35)])
#Create new csv file with the cleaned data
write.csv(updated_dataset, file = paste0(dir_path, "/final_Edinburgh_data.csv"),row.names=FALSE)

```

