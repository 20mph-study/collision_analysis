---
title: "Collision_analysis"
output: html_document
---

>Edinburgh has changed speed limits to 20mph for many roads. In this work we would like to see the impact of this policy and how it has influenced with the number of the accidents.
We are using STATS19 data for the city of Edinburgh. Data consists of 3 tables named as accidents, casualties and vehicles. We are interested in the accidents from 2013 to 2015(pre 20mph) and from 2018 to 2019(post 2omph). Accidents contain information for the location ,condition of the variables and severity variables ,32 in total. We also have Gis information and especially shapefiles for the Edinburgh's road network and control zones. They contain crucial information such as roads that have changed to 20mph or not. The aim is to link every accident with a specific type of road and in a specific zone. The detailed description of the data is as follows.


```{r,echo=FALSE,warning=FALSE,message=FALSE}
# Load libraries
library(rgdal)
library(leaflet)
library(tidyverse)
library(rgeos)
library(raster)
library(ggplot2)
library(sf)
library(mapview)
library(maptools)
library(sp)
library(readxl)
library(readr)
library(grid)
library(gridExtra)

#1.Function for keeping data of Edinburgh with speed limits 20/30/40
filter_data <- function(data){
  data <- data %>% filter(data$Speed_limit %in% c(20,30,40)) 
  data <- data %>% filter(data$`Local_Authority_(District)` == 923)
  #data$Date <- as.Date(data$Date,format="%d/%m/%Y")
  data <- na.omit(data[1:31])#remove NA obs
  return(data)
}

#2.Function for deleting Na points
delete_na <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}
```



```{r,echo=FALSE,warning=FALSE,message=FALSE} 
#Data inputs
##1.Data path 
dir_path <- "C:\\Users\\Kyriaki Kokka\\Desktop\\"
#dir_path <- "V:\\Studies\\MOVED\\HealthImpact\\Data\\"

#2.Gis 
#Read geodatabase for Edinburgh
#Path
gdb_path <- paste0(dir_path, "20mph study collisions\\20mph.gdb")
gdb_layers <- ogrListLayers(gdb_path)

#Read shapefiles
edin_impl_zones <- readOGR(dsn = gdb_path, layer="ImplementationZones")
edin_cons_streets <- readOGR(dsn = gdb_path,layer="Consultation20mphStreets")

#Put ID column as variable 
edin_cons_streets@data <-rowid_to_column(edin_cons_streets@data, "ID")

#Transform to long/lat
edin_cons_streets <- spTransform(edin_cons_streets, "+init=epsg:4326")
edin_impl_zones <- spTransform(edin_impl_zones, "+init=epsg:4326")
```

##Initial experimentation of the Edinburgh road network and zones

Edinburgh road network dataframe contains four columns. We focus on the column "LAYER" to link every accident with a specific type of road. 
We also want to link every accident with one of the following zones

Zone          | Area
------------- | -------------
1             | a)City Center, b) Rural west
2             | North 
3             | South central/East
4             | North West 
5             | West
6             | South 
```{r,echo=FALSE,warning=FALSE,message=FALSE} 
kableExtra::kable(names(edin_cons_streets))
n <- spplot(edin_cons_streets,'LAYER')
#names(edin_impl_zones)
k <- spplot(edin_impl_zones,"ImplementationZone")
grid.arrange(n,k)
```


### Visualization of the road network

```{r, echo=FALSE, warning=FALSE,message=FALSE}
df_road <- fortify(edin_cons_streets)
y<-ggplot(data = df_road, aes(x = long, y = lat,group=group)) + geom_path() 

```

### Description of dataset

Prepare the data
> We select the data of Edinburgh and we split the data into two groups according the year of each accident. First group,named as pre 20mph, includes data from 2013 to 2015 and the second group,named as post 20mph includes data from 2018 and part of 2019.We clean the data ,keeping observations only for Edinburgh. Also we select accidents with speed limits of our interest namely 20mph,30mph and 40mph to reduce the size of the dataset. We have also excluded the not known variables of the longitude and the latitude.




```{r, echo=FALSE, warning=FALSE,message=FALSE}
#3.Read csv files
#Read every year seperately
#Read csv file from 2005 to 2014
rd_source <- read_csv(paste0(dir_path, "20mph study collisions\\collisions\\collisions 2005 to 2014.csv"))  
rd_source$Date <- as.Date(rd_source$Date,format="%d/%m/%Y")

#2013 data
rd_2013 <- rd_source[rd_source$Date >="2013-01-01" & rd_source$Date <= "2013-12-31", ] %>% filter(!is.na(Date))
rd_2013$Date <- as.Date(rd_2013$Date,format="%d/%m/%Y")

#2014 data
rd_2014 <- rd_source[rd_source$Date >="2014-01-01" & rd_source$Date <= "2014-12-31", ] %>% filter(!is.na(Date))
rd_2014b <- read_csv(paste0(dir_path, "20mph study collisions\\collisions\\collisions 2014.csv"))
rd_2014b$Date <- as.Date(rd_2014b$Date,format="%d/%m/%Y")
rd_2014 <- rbind(rd_2014,rd_2014b)
rd_2014$Date <- as.Date(rd_2014$Date,format="%d/%m/%Y")

#2015 data
rd_2015 <- read_csv(paste0(dir_path, "20mph study collisions\\collisions\\collisions 2015.csv"))
rd_2015$Date <- as.Date(rd_2015$Date,format="%d/%m/%Y")

#2018 data
rd_2018 <- read_csv(paste0(dir_path, "20mph study collisions\\collisions\\collisions 2018.csv"))
rd_2018$Date <- as.Date(rd_2018$Date,format="%d/%m/%Y")

#2019 data
#rd_2019 <- read_excel("C:\\Users\\Kyriaki Kokka\\Desktop\\20mph study collisions\\collisions\\collisions 2019 Jan to May Edinburgh only.xls")
#rd_2019 <- rd_2019%>%filter(rd_2019$`Speed Limit`  %in% c(20,30,40)) 

edin_road_data <-rbind(rd_2013,rd_2014,rd_2015,rd_2018) 
edin_road_data <- filter_data(edin_road_data)
edin_road_data <-delete_na(edin_road_data,c("Longitude","Latitude"))
data <- edin_road_data
library(Hmisc)
```
#Variables of Stats19

```{r, echo=FALSE, warning=FALSE,message=FALSE}
names(edin_road_data)
```

### Summary statistics of the Speed limit 
```{r, echo=FALSE, warning=FALSE,message=FALSE}
describe(edin_road_data[18])
summary(edin_road_data[18])
```

##Descriptive plots of the data

```{r, echo=FALSE, warning=FALSE,message=FALSE}
rd <- edin_road_data

# Create and arrange levels
levels <- rd %>%
  group_by(Speed_limit) %>%
  summarise(n = n()) %>%
  arrange(desc(n))
print(levels)
# Convert to factor
rd$Speed_limit <- factor(rd$Speed_limit, levels = levels$Speed_limit)

accTot <- rd %>%
  group_by(Speed_limit) %>%
  summarise(n = n()) %>%
  ggplot(aes(x = Speed_limit, y = n, fill = Speed_limit)) +
  geom_bar(stat = "identity", alpha = .5, position = position_dodge()) +
  scale_fill_brewer(palette = "Set1") +
  scale_x_discrete(limits = rev(levels(rd$Speed_limit))) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(x = NULL, y = NULL,
       title = "",
       subtitle = "a. Accidents per speed limit (total)")

rd$Date <- as.numeric(rd$Date)
vehImp <- rd %>%
  count(Speed_limit, Date) %>%
  ungroup %>%
  group_by(Date) %>%
  mutate(p = n/sum(n)) %>%
  ggplot(aes(x = Date, y = Speed_limit, fill = Speed_limit)) +
  geom_bar(stat = "identity", alpha = .5, position = position_dodge()) +
  scale_fill_brewer(palette = "Set1") +
  scale_x_continuous(breaks = c(1, 2, 3, 4), labels = c("Front", "Back", "Offside", "Nearside"))  +
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank()) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  labs(x = NULL, y = NULL,
       title = "",
       subtitle = "c. First point of impact") +
  facet_wrap(~Speed_limit)

grid.arrange(accTot)
grid.arrange(vehImp)

```

**Visualize points per speed limit for the years of our interest

```{r, echo=FALSE, warning=FALSE,message=FALSE}

a <- ggplot(data =edin_road_data[edin_road_data$Date >="2013-01-01" & edin_road_data$Date <= "2013-12-31", ] ,aes(x = Longitude, y = Latitude, col=Speed_limit)) + geom_point(alpha=0.9) + ggtitle("2013")
b <- ggplot(data =edin_road_data[edin_road_data$Date >="2014-01-01" & edin_road_data$Date <= "2014-12-31", ] ,aes(x = Longitude, y = Latitude, col=Speed_limit)) + geom_point(alpha=0.9) + ggtitle("2014")
c <- ggplot(data =edin_road_data[edin_road_data$Date >="2015-01-01" & edin_road_data$Date <= "2015-12-31", ] ,aes(x = Longitude, y = Latitude, col=Speed_limit)) + geom_point(alpha=0.9) + ggtitle("2015")
d <- ggplot(data =edin_road_data[edin_road_data$Date >="2013-01-01" & edin_road_data$Date <= "2015-12-31", ] ,aes(x = Longitude, y = Latitude, col=Speed_limit)) + geom_point(alpha=0.9) + ggtitle("Pre 20mph data")
e <- ggplot(data =edin_road_data[edin_road_data$Date >="2018-01-01" & edin_road_data$Date <= "2018-12-31", ] ,aes(x = Longitude, y = Latitude, col=Speed_limit)) + geom_point(alpha=0.9) + ggtitle("2018")
f <- e <- ggplot(data =edin_road_data[edin_road_data$Date >="2018-01-01" & edin_road_data$Date <= "2018-12-31", ] ,aes(x = Longitude, y = Latitude, col=Speed_limit)) + geom_point(alpha=0.9) + ggtitle("Post 20mph data")
grid.arrange(a,b,c,d,e)

```
**Time series analysis

>We explore seasonal trends in accidents by day of the year and time of the day:

```{r, echo=FALSE, warning=FALSE,message=FALSE}


edin_road_data <-rowid_to_column(edin_road_data, "ID")
# library(ggplot2)
# speed_limit_dates = edin_road_data %>%
#   group_by(Date) %>%
#   summarise(
#     mph_20 = sum(edin_road_data$Speed_limit == 20),
#     mph_30 = sum(edin_road_data$Speed_limit == 30),
#     mph_40 = sum(edin_road_data$Speed_limit == 40)
#   )%>%
#   tidyr::gather(Speed_limit ,speed_limit_dates, -Date)
# ggplot(speed_limit_dates, aes(x = Date, y = speed_limit_dates,group=speed_limit_dates)) + ylab("Accidents per day")
# 
# library(stringr)
# 
# accident_times = edin_road_data %>% 
#   group_by(hour = as.numeric(str_sub(Time, 1, 2))) %>% 
#   summarise(
#     mph_20 = sum(edin_road_data$Speed_limit == 20),
#     mph_30 = sum(edin_road_data$Speed_limit == 30),
#     mph_40 = sum(edin_road_data$Speed_limit == 40)
#     ) %>% 
#   tidyr::gather(ID, Speed_limit, -hour)

#ggplot(accident_times, aes(hour, accident_times)) +
 # geom_line(aes(colour = ID))



date <- ggplot(edin_road_data, aes(x=Date,y=Speed_limit)) + geom_line( color="blue",size = 0.01,pch=1) +
    xlab("Date") + ylab("Speed limits") + ggtitle("Accidents per year")

time <-  ggplot(edin_road_data, aes(x=Time,y=Speed_limit)) + geom_line( color="blue",size = 0.01,pch=1) +
    xlab("Time") + ylab("Speed limits") + ggtitle("Accidents per year")
  
grid.arrange(date,time)

#plot(edin_road_data$Date,speed_limit_dates)

```

**Visualize points per speed limit in the road network per year

```{r, echo=FALSE, warning=FALSE,message=FALSE}
df_road <- fortify(edin_cons_streets)
rd_13 <- filter_data(rd_2013)
y <- ggplot(data = df_road, aes(x = long, y = lat,group=group)) + geom_path()
y+ geom_point(data = rd_13, aes(x = Longitude, y = Latitude,group=Speed_limit))  + ggtitle("Road network mapped with accidents of 2013") 

```


## Map accidents to Edinburgh road network
Our approach is to map every accident to the nearest road with max distance of 20 meters. For that reason we use the snapPointstolines() function that creates a projection of the point to the nearest line.

```{r, echo=FALSE, warning=FALSE,message=FALSE}
#Functions for the analysis
#Function for the nearest line
nearest_line <-function(df,road_net){
  #Create planar(cartesian) projection 
  crs <- CRS( "+proj=utm +zone=32 +ellps=WGS72 +units=m +no_defs")     # UTM zone = 32 N
  wgs84 <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")  # long/lat
  
  #Convert data to planar projection  
  road_net <- spTransform(road_net,crs)
  df <-  spTransform(SpatialPointsDataFrame(coords = df[5:6],proj4string = wgs84,data = df), crs)
  
  #Make sure our data have same projections
  proj4string(df) <- proj4string(road_net)
  
  #Find nearest line with maxDist=20m 
  nearest_line_sp <- snapPointsToLines(df,road_net,maxDist=20)
  
  return(nearest_line_sp)
}

#Function for leaflet visualisations
leaflet_map <- function(final_df,road_df,edin_streets){
  crs <- CRS( "+proj=utm +zone=32 +ellps=WGS72 +units=m +no_defs")     # UTM zone = 32 N
  wgs84 <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")  # long/lat
  
  #Convert data to planar projection  
  edin_streets <- spTransform(edin_streets,crs)
  coordinates(road_df) <- ~ Longitude + Latitude
  coordinates(final_df) <- ~ X + Y
  
  #Convert data projections back to lat/long to plot with leaflet
  edin_streets <- spTransform(edin_streets,"+init=epsg:4326")
  
  #Same projections
  proj4string(final_df) <- proj4string(edin_streets)
  proj4string(road_df) <- proj4string(edin_streets)
  
  edin_streets <- st_as_sf(edin_streets)
  #Leaflet maps of the road network , accidents and their projections
  road_existing_20 <-edin_streets%>% filter(edin_streets$LAYER == "20mph existing streets")
  road_local_20 <- filter(edin_streets, edin_streets$LAYER == "20mph local streets")
  road_main_20 <- filter(edin_streets, edin_streets$LAYER == "20mph main streets")
  road_30 <- filter(edin_streets, edin_streets$LAYER == "30mph")
  road_40 <- filter(edin_streets, edin_streets$LAYER == "40mph")
  road_part <- filter(edin_streets, edin_streets$LAYER == "Part time 20mph")
  road_50 <- filter(edin_streets, edin_streets$LAYER == "50, 60 or 70mph")
  road_trunk <- filter(edin_streets, edin_streets$LAYER == "Trunk roads")
  
  
  #Visualize
  map <- leaflet() %>% addTiles() %>% addPolygons(data = edin_streets)
  map_near <-map %>% leaflet() %>% addTiles() %>% addMarkers(lng =final_df$X, lat = final_df$Y,
                                                             popup =paste("Accident index: ", final_df$Accident_Index, "<br>",
                                                                          "Speed limit: ", final_df$Speed_limit ,"<br>",
                                                                          "Layer: ",final_df$LAYER,"<br>",
                                                                          "1st road class: ",final_df$X1st_Road_Class, "<br>",
                                                                          "2nd road class: ", final_df$X2nd_Road_Class,"<br>",
                                                                          "Road Type: ",  final_df$Road_Type))
  road_df <- (data.frame(road_df))
  map3 <- map_near %>% addCircleMarkers(lng =road_df$Longitude , lat = road_df$Latitude,
                                        popup =paste("Accident index: ", road_df$Accident_Index, "<br>",
                                                     "Speed limit: ", road_df$Speed_limit ,"<br>",
                                                     "1st road class: ",road_df$`1st_Road_Class`, "<br>",
                                                     "2nd road class: ", road_df$`2nd_Road_Class`,"<br>",
                                                     "Road Type: ", road_df$Road_Type ))
  
  
  map3 %>% 
    addPolylines(data = road_existing_20, color= "green")%>%
    addPolylines(data = road_local_20,color= "red")%>%
    addPolylines(data = road_main_20,color= "yellow")%>%
    addPolylines(data = road_30,color= "cyan")%>%
    addPolylines(data = road_40,color= "blue")%>%
    addPolylines(data = road_part,color= "black")%>%
    addPolylines(data = road_50,color= "purple")%>%
    addPolylines(data = road_trunk,color= "orange")
}

 
#pre 20mph (bind 2013-2015)
pre_20 <- edin_road_data[edin_road_data$Date >="2013-01-01" & edin_road_data$Date <= "2015-12-31", ] %>% filter(!is.na(Date))

#post 20mph (2018)
post_20 <-  edin_road_data[edin_road_data$Date >="2018-01-01" & edin_road_data$Date <= "2018-12-31", ] %>% filter(!is.na(Date))

#Data manipulation
#Get nearest line for pre and post 20mph using the nearest_line function 
nearest_pre <- nearest_line(pre_20,edin_cons_streets)
nearest_pre <- spTransform(nearest_pre,"+init=epsg:4326")
```


```{r, echo=FALSE, warning=FALSE,message=FALSE}
nearest_post <- nearest_line(post_20,edin_cons_streets)
nearest_post <- spTransform(nearest_post,"+init=epsg:4326")
```


```{r, echo=FALSE, warning=FALSE,message=FALSE}
#Merge the dataframes based on the ID of the nearest line in order to connect geoinformation with stasts19 
merged_pre <- merge(data.frame(nearest_pre),edin_cons_streets@data,by.x = "nearest_line_id" ,by.y = "ID")
merged_post <- merge(data.frame(nearest_post),edin_cons_streets@data,by.x = "nearest_line_id" ,by.y = "ID")
```

#Visualisation of results
##Map with road network and accidents pre 20mph
> We have the road network of Edinburgh with the points (blue circles) and the projected points to the nearest road. There are popups for both of the points available. The road network is explained as follows:
Type of road        | Colour
--------------------| -------------
20mph existing roads| green
20 local roads      | red 
20 main roads       | yellow
30mph               | cyan 
40mph               | blue
50,60,70mph         | black 
Part time 20mph     | purple
Trunk roads         | orange

```{r, echo=FALSE, warning=FALSE,message=FALSE}
#Visualize
leaflet_map(merged_pre,edin_road_data[edin_road_data$Date >="2013-01-01" & edin_road_data$Date <= "2015-12-31", ],edin_cons_streets)
```
##Map with road network and accidents pre 20mph

```{r, echo=FALSE, warning=FALSE,message=FALSE}
leaflet_map(merged_post,edin_road_data[edin_road_data$Date >="2018-01-01" & edin_road_data$Date <= "2018-12-31", ],edin_cons_streets)

```
##Map with zones and accidents

```{r}

edin_impl_zones <- readOGR(dsn = gdb_path, layer="ImplementationZones")

#Create planar(cartesian) projection 
crs <- CRS( "+proj=utm +zone=32 +ellps=WGS72 +units=m +no_defs")     # UTM zone = 32 N
wgs84 <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")  # long/lat

#Convert data to planar projection  
edin_impl_zones <- spTransform(edin_impl_zones,crs)
utm_data <-  spTransform(SpatialPointsDataFrame(coords = data[4:5],proj4string = wgs84,data = data), crs)

proj4string(utm_data) <- proj4string(edin_impl_zones)

#add a buffer around the point
points_polygons <- gBuffer(utm_data, width=5, byid = TRUE )
count_zones <- over(points_polygons,edin_impl_zones,returnList = FALSE)
count_zones <- rowid_to_column(count_zones,"ID")
data <- rowid_to_column(data,"index_ID")
total_zones <- merge(data,count_zones,by.x="index_ID",by.y="ID")
df_zones <-data.frame(total_zones[2],total_zones[5],total_zones[6],total_zones[35])

#Convert data projections back to lat/long to plot with leaflet
edin_impl_zones <- spTransform(edin_impl_zones,"+init=epsg:4326")
#total_zones <- spTransform(total_zones, "+init=epsg:4326")
utm_data <- spTransform(utm_data, "+init=epsg:4326")


df_na <- na.omit(df_zones[1:4]) # check how many are missing
```


```{r}
edin_impl_zones <- st_as_sf(edin_impl_zones)
#Leaflet maps of the zones & accidents
zone_1 <- filter(edin_impl_zones,edin_impl_zones$ImplementationZone == 1)
zone_2 <- filter(edin_impl_zones,edin_impl_zones$ImplementationZone == 2)
zone_3 <- filter(edin_impl_zones,edin_impl_zones$ImplementationZone == 3)
zone_4 <- filter(edin_impl_zones,edin_impl_zones$ImplementationZone == 4)
zone_5 <- filter(edin_impl_zones,edin_impl_zones$ImplementationZone == 5)
zone_6 <- filter(edin_impl_zones,edin_impl_zones$ImplementationZone == 6)

#Visualize
map_zones <- leaflet() %>% addTiles() %>% 
  addPolygons(data = zone_1, color= "green")%>%
  addPolygons(data = zone_2,color= "red")%>%
  addPolygons(data = zone_3,color= "purple")%>%
  addPolygons(data = zone_4,color= "cyan")%>%
  addPolygons(data = zone_5,color= "blue")%>%
  addPolygons(data = zone_6,color= "orange")

map_zones %>% addMarkers(lng =df_zones$Longitude, lat = df_zones$Latitude, 
                         popup =paste("Accident index: ", df_zones$Accident_Index, "<br>",
                                      "Zone: ", df_zones$ImplementationZone))
```

